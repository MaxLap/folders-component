{"version":3,"sources":["app.js"],"names":["_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","Constructor","protoProps","staticProps","prototype","_classCallCheck","instance","TypeError","ComponentManager","permissions","onReady","_this","sentMessages","messageQueue","initialPermissions","loggingEnabled","acceptsThemes","onReadyCallback","coallesedSaving","coallesedSavingDelay","messageHandler","event","mobileSource","console","log","data","origin","JSON","parse","handleMessage","document","addEventListener","window","value","payload","action","sessionKey","componentData","activateThemes","themes","original","originalMessage","filter","message","messageId","alert","callback","requestPermissions","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_iterator","Symbol","iterator","_step","next","done","postMessage","err","return","environment","platform","uuid","getSelfComponentUUID","isRunningInDesktopApplication","setComponentDataValueForKey","clearComponentData","componentDataValueForKey","push","generateUUID","api","sentMessage","stringify","parent","setSize","type","width","height","bind","streamItems","contentTypes","Array","isArray","content_types","items","streamContextItem","item","selectItem","jsonObjectForItem","createItem","associateItem","createItems","_this2","mapped","map","deassociateItem","clearSelection","content_type","deleteItem","deleteItems","params","sendCustomEvent","saveItem","skipDebouncer","arguments","saveItems","saveItemWithPresave","presave","saveItemsWithPresave","_this3","saveBlock","mappedItems","updated_at","Date","pendingSave","clearTimeout","setTimeout","copy","assign","children","getItemAppDataValue","AppDomain","content","appData","urls","deactivateAllCustomThemes","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_iterator2","_step2","url","link","createElement","href","rel","media","className","getElementsByTagName","appendChild","elements","from","getElementsByClassName","slice","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_iterator3","_step3","element","disabled","parentNode","removeChild","crypto","msCrypto","buf","Uint32Array","getRandomValues","idx","replace","c","r","v","toString","d","getTime","performance","now","Math","random","floor","module","exports","angular","HomeCtrl","$rootScope","$scope","$timeout","smartTagContentType","componentManager","delimiter","resolveRawTags","masterTag","sortTags","tags","sort","a","b","title","resolved","rawTags","findResolvedTag","tag","pendingDummy","find","dummy","unshift","name","comps","split","displayTitle","getParent","depth","parentTitle","join","tagTitle","index","indexOf","splice","selectedTag","setSelectedForTag","changeParent","sourceId","targetId","source","needsSave","adjustChildren","child","newTitle","master","createTag","startsWith","components","substring","e","smartTag","predicate","keypath","operator","createdTag","selectOnLoad","selectTag","multiSelect","isSmartTag","clearMultipleTagsSelection","multipleTags","smartMaster","createEphemeralSmartTagForMultiTags","editing","tagNames","toggleCollapse","clientData","collapsed","saveTags","selected","newTags","allTags","smartTags","smartMasterTag","arrayToUse","existing","tagCandidate","deleted","deleteTag","deleteChain","addChildren","$$ngIsClass","controller","directive","restrict","scope","shouldFocus","$element","focus","tagId","drop","isDraggable","isDroppable","attrs","el","draggable","counter","dataTransfer","effectAllowed","setData","classList","add","remove","dropEffect","preventDefault","stopPropagation","getData","$apply","TagTree","templateUrl","onSelect","onToggleCollapse","onDrop","onDragOver","onDragStart","ctrlKey","metaKey","addChild","$event","addingTag","saveNewTag","removeTag","innerCollapse","saveTagRename","renameChildren","generationForTag","generation","circleClassForTag","gen","circleClass"],"mappings":"AAAA;;;;;;AAEA,IAAIA,eAAe,YAAY;AAAE,WAASC,gBAAT,CAA0BC,MAA1B,EAAkCC,KAAlC,EAAyC;AAAE,SAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAID,MAAME,MAA1B,EAAkCD,GAAlC,EAAuC;AAAE,UAAIE,aAAaH,MAAMC,CAAN,CAAjB,CAA2BE,WAAWC,UAAX,GAAwBD,WAAWC,UAAX,IAAyB,KAAjD,CAAwDD,WAAWE,YAAX,GAA0B,IAA1B,CAAgC,IAAI,WAAWF,UAAf,EAA2BA,WAAWG,QAAX,GAAsB,IAAtB,CAA4BC,OAAOC,cAAP,CAAsBT,MAAtB,EAA8BI,WAAWM,GAAzC,EAA8CN,UAA9C;AAA4D;AAAE,GAAC,OAAO,UAAUO,WAAV,EAAuBC,UAAvB,EAAmCC,WAAnC,EAAgD;AAAE,QAAID,UAAJ,EAAgBb,iBAAiBY,YAAYG,SAA7B,EAAwCF,UAAxC,EAAqD,IAAIC,WAAJ,EAAiBd,iBAAiBY,WAAjB,EAA8BE,WAA9B,EAA4C,OAAOF,WAAP;AAAqB,GAAhN;AAAmN,CAA9hB,EAAnB;;AAEA,SAASI,eAAT,CAAyBC,QAAzB,EAAmCL,WAAnC,EAAgD;AAAE,MAAI,EAAEK,oBAAoBL,WAAtB,CAAJ,EAAwC;AAAE,UAAM,IAAIM,SAAJ,CAAc,mCAAd,CAAN;AAA2D;AAAE;;AAEzJ,IAAIC,mBAAmB,YAAY;AACjC,WAASA,gBAAT,CAA0BC,WAA1B,EAAuCC,OAAvC,EAAgD;AAC9C,QAAIC,QAAQ,IAAZ;;AAEAN,oBAAgB,IAAhB,EAAsBG,gBAAtB;;AAEA,SAAKI,YAAL,GAAoB,EAApB;AACA,SAAKC,YAAL,GAAoB,EAApB;AACA,SAAKC,kBAAL,GAA0BL,WAA1B;AACA,SAAKM,cAAL,GAAsB,KAAtB;AACA,SAAKC,aAAL,GAAqB,IAArB;AACA,SAAKC,eAAL,GAAuBP,OAAvB;;AAEA,SAAKQ,eAAL,GAAuB,IAAvB;AACA,SAAKC,oBAAL,GAA4B,GAA5B;;AAEA,QAAIC,iBAAiB,SAASA,cAAT,CAAwBC,KAAxB,EAA+BC,YAA/B,EAA6C;AAChE,UAAIX,MAAMI,cAAV,EAA0B;AACxBQ,gBAAQC,GAAR,CAAY,kCAAZ,EAAgDH,MAAMI,IAAtD,EAA4D,SAA5D,EAAuEH,YAAvE;AACD;;AAED;AACA;AACA,UAAI,CAACX,MAAMe,MAAX,EAAmB;AACjBf,cAAMe,MAAN,GAAeL,MAAMK,MAArB;AACD;AACDf,YAAMW,YAAN,GAAqBA,YAArB;AACA;AACA,UAAIG,OAAOH,eAAeK,KAAKC,KAAL,CAAWP,MAAMI,IAAjB,CAAf,GAAwCJ,MAAMI,IAAzD;AACAd,YAAMkB,aAAN,CAAoBJ,IAApB;AACD,KAdD;;AAgBA;AACA;;AAEAK,aAASC,gBAAT,CAA0B,SAA1B,EAAqC,UAAUV,KAAV,EAAiB;AACpDD,qBAAeC,KAAf,EAAsB,IAAtB;AACD,KAFD,EAEG,KAFH;;AAIAW,WAAOD,gBAAP,CAAwB,SAAxB,EAAmC,UAAUV,KAAV,EAAiB;AAClDD,qBAAeC,KAAf,EAAsB,KAAtB;AACD,KAFD,EAEG,KAFH;AAGD;;AAEDjC,eAAaoB,gBAAb,EAA+B,CAAC;AAC9BR,SAAK,eADyB;AAE9BiC,WAAO,SAASJ,aAAT,CAAuBK,OAAvB,EAAgC;AACrC,UAAIA,QAAQC,MAAR,KAAmB,sBAAvB,EAA+C;AAC7C,aAAKC,UAAL,GAAkBF,QAAQE,UAA1B;AACA,aAAKC,aAAL,GAAqBH,QAAQG,aAA7B;AACA,aAAK3B,OAAL,CAAawB,QAAQT,IAArB;;AAEA,YAAI,KAAKV,cAAT,EAAyB;AACvBQ,kBAAQC,GAAR,CAAY,iDAAZ,EAA+DU,OAA/D;AACD;AACF,OARD,MAQO,IAAIA,QAAQC,MAAR,KAAmB,QAAvB,EAAiC;AACtC,YAAI,KAAKnB,aAAT,EAAwB;AACtB,eAAKsB,cAAL,CAAoBJ,QAAQT,IAAR,CAAac,MAAjC;AACD;AACF,OAJM,MAIA,IAAIL,QAAQM,QAAZ,EAAsB;AAC3B;AACA,YAAIC,kBAAkB,KAAK7B,YAAL,CAAkB8B,MAAlB,CAAyB,UAAUC,OAAV,EAAmB;AAChE,iBAAOA,QAAQC,SAAR,KAAsBV,QAAQM,QAAR,CAAiBI,SAA9C;AACD,SAFqB,EAEnB,CAFmB,CAAtB;;AAIA,YAAI,CAACH,eAAL,EAAsB;AACpB;AACAI,gBAAM,4JAAN;AACD;;AAED,YAAIJ,gBAAgBK,QAApB,EAA8B;AAC5BL,0BAAgBK,QAAhB,CAAyBZ,QAAQT,IAAjC;AACD;AACF;AACF;AA9B6B,GAAD,EA+B5B;AACDzB,SAAK,SADJ;AAEDiC,WAAO,SAASvB,OAAT,CAAiBe,IAAjB,EAAuB;AAC5B,UAAI,KAAKX,kBAAL,IAA2B,KAAKA,kBAAL,CAAwBrB,MAAxB,GAAiC,CAAhE,EAAmE;AACjE,aAAKsD,kBAAL,CAAwB,KAAKjC,kBAA7B;AACD;;AAED,UAAIkC,4BAA4B,IAAhC;AACA,UAAIC,oBAAoB,KAAxB;AACA,UAAIC,iBAAiBC,SAArB;;AAEA,UAAI;AACF,aAAK,IAAIC,YAAY,KAAKvC,YAAL,CAAkBwC,OAAOC,QAAzB,GAAhB,EAAsDC,KAA3D,EAAkE,EAAEP,4BAA4B,CAACO,QAAQH,UAAUI,IAAV,EAAT,EAA2BC,IAAzD,CAAlE,EAAkIT,4BAA4B,IAA9J,EAAoK;AAClK,cAAIL,UAAUY,MAAMtB,KAApB;;AAEA,eAAKyB,WAAL,CAAiBf,QAAQR,MAAzB,EAAiCQ,QAAQlB,IAAzC,EAA+CkB,QAAQG,QAAvD;AACD;AACF,OAND,CAME,OAAOa,GAAP,EAAY;AACZV,4BAAoB,IAApB;AACAC,yBAAiBS,GAAjB;AACD,OATD,SASU;AACR,YAAI;AACF,cAAI,CAACX,yBAAD,IAA8BI,UAAUQ,MAA5C,EAAoD;AAClDR,sBAAUQ,MAAV;AACD;AACF,SAJD,SAIU;AACR,cAAIX,iBAAJ,EAAuB;AACrB,kBAAMC,cAAN;AACD;AACF;AACF;;AAED,WAAKrC,YAAL,GAAoB,EAApB;AACA,WAAKgD,WAAL,GAAmBpC,KAAKoC,WAAxB;AACA,WAAKC,QAAL,GAAgBrC,KAAKqC,QAArB;AACA,WAAKC,IAAL,GAAYtC,KAAKsC,IAAjB;;AAEA,UAAI,KAAK9C,eAAT,EAA0B;AACxB,aAAKA,eAAL;AACD;AACF;AAxCA,GA/B4B,EAwE5B;AACDjB,SAAK,sBADJ;AAEDiC,WAAO,SAAS+B,oBAAT,GAAgC;AACrC,aAAO,KAAKD,IAAZ;AACD;AAJA,GAxE4B,EA6E5B;AACD/D,SAAK,+BADJ;AAEDiC,WAAO,SAASgC,6BAAT,GAAyC;AAC9C,aAAO,KAAKJ,WAAL,KAAqB,SAA5B;AACD;AAJA,GA7E4B,EAkF5B;AACD7D,SAAK,6BADJ;AAEDiC,WAAO,SAASiC,2BAAT,CAAqClE,GAArC,EAA0CiC,KAA1C,EAAiD;AACtD,WAAKI,aAAL,CAAmBrC,GAAnB,IAA0BiC,KAA1B;AACA,WAAKyB,WAAL,CAAiB,oBAAjB,EAAuC,EAAErB,eAAe,KAAKA,aAAtB,EAAvC,EAA8E,UAAUZ,IAAV,EAAgB,CAAE,CAAhG;AACD;AALA,GAlF4B,EAwF5B;AACDzB,SAAK,oBADJ;AAEDiC,WAAO,SAASkC,kBAAT,GAA8B;AACnC,WAAK9B,aAAL,GAAqB,EAArB;AACA,WAAKqB,WAAL,CAAiB,oBAAjB,EAAuC,EAAErB,eAAe,KAAKA,aAAtB,EAAvC,EAA8E,UAAUZ,IAAV,EAAgB,CAAE,CAAhG;AACD;AALA,GAxF4B,EA8F5B;AACDzB,SAAK,0BADJ;AAEDiC,WAAO,SAASmC,wBAAT,CAAkCpE,GAAlC,EAAuC;AAC5C,aAAO,KAAKqC,aAAL,CAAmBrC,GAAnB,CAAP;AACD;AAJA,GA9F4B,EAmG5B;AACDA,SAAK,aADJ;AAEDiC,WAAO,SAASyB,WAAT,CAAqBvB,MAArB,EAA6BV,IAA7B,EAAmCqB,QAAnC,EAA6C;AAClD,UAAI,CAAC,KAAKV,UAAV,EAAsB;AACpB,aAAKvB,YAAL,CAAkBwD,IAAlB,CAAuB;AACrBlC,kBAAQA,MADa;AAErBV,gBAAMA,IAFe;AAGrBqB,oBAAUA;AAHW,SAAvB;AAKA;AACD;;AAED,UAAIH,UAAU;AACZR,gBAAQA,MADI;AAEZV,cAAMA,IAFM;AAGZmB,mBAAW,KAAK0B,YAAL,EAHC;AAIZlC,oBAAY,KAAKA,UAJL;AAKZmC,aAAK;AALO,OAAd;;AAQA,UAAIC,cAAc7C,KAAKC,KAAL,CAAWD,KAAK8C,SAAL,CAAe9B,OAAf,CAAX,CAAlB;AACA6B,kBAAY1B,QAAZ,GAAuBA,QAAvB;AACA,WAAKlC,YAAL,CAAkByD,IAAlB,CAAuBG,WAAvB;;AAEA;AACA,UAAI,KAAKlD,YAAT,EAAuB;AACrBqB,kBAAUhB,KAAK8C,SAAL,CAAe9B,OAAf,CAAV;AACD;;AAED,UAAI,KAAK5B,cAAT,EAAyB;AACvBQ,gBAAQC,GAAR,CAAY,kBAAZ,EAAgCmB,OAAhC;AACD;;AAEDX,aAAO0C,MAAP,CAAchB,WAAd,CAA0Bf,OAA1B,EAAmC,KAAKjB,MAAxC;AACD;AAlCA,GAnG4B,EAsI5B;AACD1B,SAAK,SADJ;AAEDiC,WAAO,SAAS0C,OAAT,CAAiBC,IAAjB,EAAuBC,KAAvB,EAA8BC,MAA9B,EAAsC;AAC3C,WAAKpB,WAAL,CAAiB,UAAjB,EAA6B,EAAEkB,MAAMA,IAAR,EAAcC,OAAOA,KAArB,EAA4BC,QAAQA,MAApC,EAA7B,EAA2E,UAAUrD,IAAV,EAAgB,CAAE,CAA7F;AACD;AAJA,GAtI4B,EA2I5B;AACDzB,SAAK,oBADJ;AAEDiC,WAAO,SAASc,kBAAT,CAA4BtC,WAA5B,EAAyCqC,QAAzC,EAAmD;AACxD,WAAKY,WAAL,CAAiB,qBAAjB,EAAwC,EAAEjD,aAAaA,WAAf,EAAxC,EAAsE,UAAUgB,IAAV,EAAgB;AACpFqB,oBAAYA,UAAZ;AACD,OAFqE,CAEpEiC,IAFoE,CAE/D,IAF+D,CAAtE;AAGD;AANA,GA3I4B,EAkJ5B;AACD/E,SAAK,aADJ;AAEDiC,WAAO,SAAS+C,WAAT,CAAqBC,YAArB,EAAmCnC,QAAnC,EAA6C;AAClD,UAAI,CAACoC,MAAMC,OAAN,CAAcF,YAAd,CAAL,EAAkC;AAChCA,uBAAe,CAACA,YAAD,CAAf;AACD;AACD,WAAKvB,WAAL,CAAiB,cAAjB,EAAiC,EAAE0B,eAAeH,YAAjB,EAAjC,EAAkE,UAAUxD,IAAV,EAAgB;AAChFqB,iBAASrB,KAAK4D,KAAd;AACD,OAFiE,CAEhEN,IAFgE,CAE3D,IAF2D,CAAlE;AAGD;AATA,GAlJ4B,EA4J5B;AACD/E,SAAK,mBADJ;AAEDiC,WAAO,SAASqD,iBAAT,CAA2BxC,QAA3B,EAAqC;AAC1C,WAAKY,WAAL,CAAiB,qBAAjB,EAAwC,IAAxC,EAA8C,UAAUjC,IAAV,EAAgB;AAC5D,YAAI8D,OAAO9D,KAAK8D,IAAhB;AACA;;;;;;;;AAQA;AACA;AACA;AACA;AACA;AACAzC,iBAASyC,IAAT;AACD,OAhBD;AAiBD;AApBA,GA5J4B,EAiL5B;AACDvF,SAAK,YADJ;AAEDiC,WAAO,SAASuD,UAAT,CAAoBD,IAApB,EAA0B;AAC/B,WAAK7B,WAAL,CAAiB,aAAjB,EAAgC,EAAE6B,MAAM,KAAKE,iBAAL,CAAuBF,IAAvB,CAAR,EAAhC;AACD;AAJA,GAjL4B,EAsL5B;AACDvF,SAAK,YADJ;AAEDiC,WAAO,SAASyD,UAAT,CAAoBH,IAApB,EAA0BzC,QAA1B,EAAoC;AACzC,WAAKY,WAAL,CAAiB,aAAjB,EAAgC,EAAE6B,MAAM,KAAKE,iBAAL,CAAuBF,IAAvB,CAAR,EAAhC,EAAwE,UAAU9D,IAAV,EAAgB;AACtF,YAAI8D,OAAO9D,KAAK8D,IAAhB;;AAEA;AACA;AACA,YAAI,CAACA,IAAD,IAAS9D,KAAK4D,KAAd,IAAuB5D,KAAK4D,KAAL,CAAW5F,MAAX,GAAoB,CAA/C,EAAkD;AAChD8F,iBAAO9D,KAAK4D,KAAL,CAAW,CAAX,CAAP;AACD;;AAED,aAAKM,aAAL,CAAmBJ,IAAnB;AACAzC,oBAAYA,SAASyC,IAAT,CAAZ;AACD,OAXuE,CAWtER,IAXsE,CAWjE,IAXiE,CAAxE;AAYD;AAfA,GAtL4B,EAsM5B;AACD/E,SAAK,aADJ;AAEDiC,WAAO,SAAS2D,WAAT,CAAqBP,KAArB,EAA4BvC,QAA5B,EAAsC;AAC3C,UAAI+C,SAAS,IAAb;;AAEA,UAAIC,SAAST,MAAMU,GAAN,CAAU,UAAUR,IAAV,EAAgB;AACrC,eAAOM,OAAOJ,iBAAP,CAAyBF,IAAzB,CAAP;AACD,OAFY,CAAb;AAGA,WAAK7B,WAAL,CAAiB,cAAjB,EAAiC,EAAE2B,OAAOS,MAAT,EAAjC,EAAoD,UAAUrE,IAAV,EAAgB;AAClEqB,oBAAYA,SAASrB,KAAK4D,KAAd,CAAZ;AACD,OAFmD,CAElDN,IAFkD,CAE7C,IAF6C,CAApD;AAGD;AAXA,GAtM4B,EAkN5B;AACD/E,SAAK,eADJ;AAEDiC,WAAO,SAAS0D,aAAT,CAAuBJ,IAAvB,EAA6B;AAClC,WAAK7B,WAAL,CAAiB,gBAAjB,EAAmC,EAAE6B,MAAM,KAAKE,iBAAL,CAAuBF,IAAvB,CAAR,EAAnC;AACD;AAJA,GAlN4B,EAuN5B;AACDvF,SAAK,iBADJ;AAEDiC,WAAO,SAAS+D,eAAT,CAAyBT,IAAzB,EAA+B;AACpC,WAAK7B,WAAL,CAAiB,kBAAjB,EAAqC,EAAE6B,MAAM,KAAKE,iBAAL,CAAuBF,IAAvB,CAAR,EAArC;AACD;AAJA,GAvN4B,EA4N5B;AACDvF,SAAK,gBADJ;AAEDiC,WAAO,SAASgE,cAAT,GAA0B;AAC/B,WAAKvC,WAAL,CAAiB,iBAAjB,EAAoC,EAAEwC,cAAc,KAAhB,EAApC;AACD;AAJA,GA5N4B,EAiO5B;AACDlG,SAAK,YADJ;AAEDiC,WAAO,SAASkE,UAAT,CAAoBZ,IAApB,EAA0BzC,QAA1B,EAAoC;AACzC,WAAKsD,WAAL,CAAiB,CAACb,IAAD,CAAjB,EAAyBzC,QAAzB;AACD;AAJA,GAjO4B,EAsO5B;AACD9C,SAAK,aADJ;AAEDiC,WAAO,SAASmE,WAAT,CAAqBf,KAArB,EAA4BvC,QAA5B,EAAsC;AAC3C,UAAIuD,SAAS;AACXhB,eAAOA,MAAMU,GAAN,CAAU,UAAUR,IAAV,EAAgB;AAC/B,iBAAO,KAAKE,iBAAL,CAAuBF,IAAvB,CAAP;AACD,SAFgB,CAEfR,IAFe,CAEV,IAFU,CAAV;AADI,OAAb;;AAMA,WAAKrB,WAAL,CAAiB,cAAjB,EAAiC2C,MAAjC,EAAyC,UAAU5E,IAAV,EAAgB;AACvDqB,oBAAYA,SAASrB,IAAT,CAAZ;AACD,OAFD;AAGD;AAZA,GAtO4B,EAmP5B;AACDzB,SAAK,iBADJ;AAEDiC,WAAO,SAASqE,eAAT,CAAyBnE,MAAzB,EAAiCV,IAAjC,EAAuCqB,QAAvC,EAAiD;AACtD,WAAKY,WAAL,CAAiBvB,MAAjB,EAAyBV,IAAzB,EAA+B,UAAUA,IAAV,EAAgB;AAC7CqB,oBAAYA,SAASrB,IAAT,CAAZ;AACD,OAF8B,CAE7BsD,IAF6B,CAExB,IAFwB,CAA/B;AAGD;AANA,GAnP4B,EA0P5B;AACD/E,SAAK,UADJ;AAEDiC,WAAO,SAASsE,QAAT,CAAkBhB,IAAlB,EAAwBzC,QAAxB,EAAkC;AACvC,UAAI0D,gBAAgBC,UAAUhH,MAAV,GAAmB,CAAnB,IAAwBgH,UAAU,CAAV,MAAiBtD,SAAzC,GAAqDsD,UAAU,CAAV,CAArD,GAAoE,KAAxF;;AAEA,WAAKC,SAAL,CAAe,CAACnB,IAAD,CAAf,EAAuBzC,QAAvB,EAAiC0D,aAAjC;AACD;;AAED;;;;;AARC,GA1P4B,EAuQ5B;AACDxG,SAAK,qBADJ;AAEDiC,WAAO,SAAS0E,mBAAT,CAA6BpB,IAA7B,EAAmCqB,OAAnC,EAA4C9D,QAA5C,EAAsD;AAC3D,WAAK+D,oBAAL,CAA0B,CAACtB,IAAD,CAA1B,EAAkCqB,OAAlC,EAA2C9D,QAA3C;AACD;AAJA,GAvQ4B,EA4Q5B;AACD9C,SAAK,sBADJ;AAEDiC,WAAO,SAAS4E,oBAAT,CAA8BxB,KAA9B,EAAqCuB,OAArC,EAA8C9D,QAA9C,EAAwD;AAC7D,WAAK4D,SAAL,CAAerB,KAAf,EAAsBvC,QAAtB,EAAgC,KAAhC,EAAuC8D,OAAvC;AACD;;AAED;;;;;AANC,GA5Q4B,EAuR5B;AACD5G,SAAK,WADJ;AAEDiC,WAAO,SAASyE,SAAT,CAAmBrB,KAAnB,EAA0BvC,QAA1B,EAAoC;AACzC,UAAIgE,SAAS,IAAb;;AAEA,UAAIN,gBAAgBC,UAAUhH,MAAV,GAAmB,CAAnB,IAAwBgH,UAAU,CAAV,MAAiBtD,SAAzC,GAAqDsD,UAAU,CAAV,CAArD,GAAoE,KAAxF;AACA,UAAIG,UAAUH,UAAU,CAAV,CAAd;;AAEA,UAAIM,YAAY,SAASA,SAAT,GAAqB;AACnC;AACAH,mBAAWA,SAAX;;AAEA,YAAII,cAAc3B,MAAMU,GAAN,CAAU,UAAUR,IAAV,EAAgB;AAC1CA,eAAK0B,UAAL,GAAkB,IAAIC,IAAJ,EAAlB;AACA,iBAAO,KAAKzB,iBAAL,CAAuBF,IAAvB,CAAP;AACD,SAH2B,CAG1BR,IAH0B,CAGrB+B,MAHqB,CAAV,CAAlB;;AAKAA,eAAOpD,WAAP,CAAmB,YAAnB,EAAiC,EAAE2B,OAAO2B,WAAT,EAAjC,EAAyD,UAAUvF,IAAV,EAAgB;AACvEqB,sBAAYA,UAAZ;AACD,SAFD;AAGD,OAZD;;AAcA;;;;;;;;;AASA,UAAI,KAAK5B,eAAL,IAAwB,IAAxB,IAAgC,CAACsF,aAArC,EAAoD;AAClD,YAAI,KAAKW,WAAT,EAAsB;AACpBC,uBAAa,KAAKD,WAAlB;AACD;;AAED,aAAKA,WAAL,GAAmBE,WAAW,YAAY;AACxCN;AACD,SAFkB,EAEhB,KAAK5F,oBAFW,CAAnB;AAGD,OARD,MAQO;AACL4F;AACD;AACF;AA1CA,GAvR4B,EAkU5B;AACD/G,SAAK,mBADJ;AAEDiC,WAAO,SAASwD,iBAAT,CAA2BF,IAA3B,EAAiC;AACtC,UAAI+B,OAAOxH,OAAOyH,MAAP,CAAc,EAAd,EAAkBhC,IAAlB,CAAX;AACA+B,WAAKE,QAAL,GAAgB,IAAhB;AACAF,WAAK5C,MAAL,GAAc,IAAd;AACA,aAAO4C,IAAP;AACD;AAPA,GAlU4B,EA0U5B;AACDtH,SAAK,qBADJ;AAEDiC,WAAO,SAASwF,mBAAT,CAA6BlC,IAA7B,EAAmCvF,GAAnC,EAAwC;AAC7C,UAAI0H,YAAY,sBAAhB;AACA,UAAIjG,OAAO8D,KAAKoC,OAAL,CAAaC,OAAb,IAAwBrC,KAAKoC,OAAL,CAAaC,OAAb,CAAqBF,SAArB,CAAnC;AACA,UAAIjG,IAAJ,EAAU;AACR,eAAOA,KAAKzB,GAAL,CAAP;AACD,OAFD,MAEO;AACL,eAAO,IAAP;AACD;AACF;;AAED;;AAZC,GA1U4B,EAwV5B;AACDA,SAAK,gBADJ;AAEDiC,WAAO,SAASK,cAAT,CAAwBuF,IAAxB,EAA8B;AACnC,WAAKC,yBAAL;;AAEA,UAAI,KAAK/G,cAAT,EAAyB;AACvBQ,gBAAQC,GAAR,CAAY,oBAAZ,EAAkCqG,IAAlC;AACD;;AAED,UAAI,CAACA,IAAL,EAAW;AACT;AACD;;AAED,UAAIE,6BAA6B,IAAjC;AACA,UAAIC,qBAAqB,KAAzB;AACA,UAAIC,kBAAkB9E,SAAtB;;AAEA,UAAI;AACF,aAAK,IAAI+E,aAAaL,KAAKxE,OAAOC,QAAZ,GAAjB,EAA0C6E,MAA/C,EAAuD,EAAEJ,6BAA6B,CAACI,SAASD,WAAW1E,IAAX,EAAV,EAA6BC,IAA5D,CAAvD,EAA0HsE,6BAA6B,IAAvJ,EAA6J;AAC3J,cAAIK,MAAMD,OAAOlG,KAAjB;;AAEA,cAAI,CAACmG,GAAL,EAAU;AACR;AACD;;AAED,cAAIC,OAAOvG,SAASwG,aAAT,CAAuB,MAAvB,CAAX;AACAD,eAAKE,IAAL,GAAYH,GAAZ;AACAC,eAAKzD,IAAL,GAAY,UAAZ;AACAyD,eAAKG,GAAL,GAAW,YAAX;AACAH,eAAKI,KAAL,GAAa,cAAb;AACAJ,eAAKK,SAAL,GAAiB,cAAjB;AACA5G,mBAAS6G,oBAAT,CAA8B,MAA9B,EAAsC,CAAtC,EAAyCC,WAAzC,CAAqDP,IAArD;AACD;AACF,OAhBD,CAgBE,OAAO1E,GAAP,EAAY;AACZqE,6BAAqB,IAArB;AACAC,0BAAkBtE,GAAlB;AACD,OAnBD,SAmBU;AACR,YAAI;AACF,cAAI,CAACoE,0BAAD,IAA+BG,WAAWtE,MAA9C,EAAsD;AACpDsE,uBAAWtE,MAAX;AACD;AACF,SAJD,SAIU;AACR,cAAIoE,kBAAJ,EAAwB;AACtB,kBAAMC,eAAN;AACD;AACF;AACF;AACF;AA/CA,GAxV4B,EAwY5B;AACDjI,SAAK,2BADJ;AAEDiC,WAAO,SAAS6F,yBAAT,GAAqC;AAC1C;AACA;AACA,UAAIe,WAAW3D,MAAM4D,IAAN,CAAWhH,SAASiH,sBAAT,CAAgC,cAAhC,CAAX,EAA4DC,KAA5D,EAAf;AACA,UAAIC,6BAA6B,IAAjC;AACA,UAAIC,qBAAqB,KAAzB;AACA,UAAIC,kBAAkBhG,SAAtB;;AAEA,UAAI;AACF,aAAK,IAAIiG,aAAaP,SAASxF,OAAOC,QAAhB,GAAjB,EAA8C+F,MAAnD,EAA2D,EAAEJ,6BAA6B,CAACI,SAASD,WAAW5F,IAAX,EAAV,EAA6BC,IAA5D,CAA3D,EAA8HwF,6BAA6B,IAA3J,EAAiK;AAC/J,cAAIK,UAAUD,OAAOpH,KAArB;;AAEA,cAAIqH,OAAJ,EAAa;AACXA,oBAAQC,QAAR,GAAmB,IAAnB;AACAD,oBAAQE,UAAR,CAAmBC,WAAnB,CAA+BH,OAA/B;AACD;AACF;AACF,OATD,CASE,OAAO3F,GAAP,EAAY;AACZuF,6BAAqB,IAArB;AACAC,0BAAkBxF,GAAlB;AACD,OAZD,SAYU;AACR,YAAI;AACF,cAAI,CAACsF,0BAAD,IAA+BG,WAAWxF,MAA9C,EAAsD;AACpDwF,uBAAWxF,MAAX;AACD;AACF,SAJD,SAIU;AACR,cAAIsF,kBAAJ,EAAwB;AACtB,kBAAMC,eAAN;AACD;AACF;AACF;AACF;;AAED;;AAnCC,GAxY4B,EA6a5B;AACDnJ,SAAK,cADJ;AAEDiC,WAAO,SAASqC,YAAT,GAAwB;AAC7B,UAAIoF,SAAS1H,OAAO0H,MAAP,IAAiB1H,OAAO2H,QAArC;AACA,UAAID,MAAJ,EAAY;AACV,YAAIE,MAAM,IAAIC,WAAJ,CAAgB,CAAhB,CAAV;AACAH,eAAOI,eAAP,CAAuBF,GAAvB;AACA,YAAIG,MAAM,CAAC,CAAX;AACA,eAAO,uCAAuCC,OAAvC,CAA+C,OAA/C,EAAwD,UAAUC,CAAV,EAAa;AAC1EF;AACA,cAAIG,IAAIN,IAAIG,OAAO,CAAX,KAAiBA,MAAM,CAAN,GAAU,CAA3B,GAA+B,EAAvC;AACA,cAAII,IAAIF,KAAK,GAAL,GAAWC,CAAX,GAAeA,IAAI,GAAJ,GAAU,GAAjC;AACA,iBAAOC,EAAEC,QAAF,CAAW,EAAX,CAAP;AACD,SALM,CAAP;AAMD,OAVD,MAUO;AACL,YAAIC,IAAI,IAAInD,IAAJ,GAAWoD,OAAX,EAAR;AACA,YAAItI,OAAOuI,WAAP,IAAsB,OAAOvI,OAAOuI,WAAP,CAAmBC,GAA1B,KAAkC,UAA5D,EAAwE;AACtEH,eAAKE,YAAYC,GAAZ,EAAL,CADsE,CAC9C;AACzB;AACD,YAAIzG,OAAO,uCAAuCiG,OAAvC,CAA+C,OAA/C,EAAwD,UAAUC,CAAV,EAAa;AAC9E,cAAIC,IAAI,CAACG,IAAII,KAAKC,MAAL,KAAgB,EAArB,IAA2B,EAA3B,GAAgC,CAAxC;AACAL,cAAII,KAAKE,KAAL,CAAWN,IAAI,EAAf,CAAJ;AACA,iBAAO,CAACJ,KAAK,GAAL,GAAWC,CAAX,GAAeA,IAAI,GAAJ,GAAU,GAA1B,EAA+BE,QAA/B,CAAwC,EAAxC,CAAP;AACD,SAJU,CAAX;AAKA,eAAOrG,IAAP;AACD;AACF;AA1BA,GA7a4B,CAA/B;;AA0cA,SAAOvD,gBAAP;AACD,CAvfsB,EAAvB;;AAyfA,IAAI,OAAOoK,MAAP,IAAiB,WAAjB,IAAgC,OAAOA,OAAOC,OAAd,IAAyB,WAA7D,EAA0E;AACxED,SAAOC,OAAP,GAAiBrK,gBAAjB;AACD;;AAED,IAAIwB,MAAJ,EAAY;AACVA,SAAOxB,gBAAP,GAA0BA,gBAA1B;AACD;AACD;AACA,CAAC;;AAEDsK,QAAQF,MAAR,CAAe,KAAf,EAAsB,EAAtB;IAGOG,Q,GACL,kBAAYC,UAAZ,EAAwBC,MAAxB,EAAgCC,QAAhC,EAA0C;AAAA;;AAExC,MAAIC,sBAAsB,aAA1B;;AAEA,MAAIC,mBAAmB,IAAIpJ,OAAOxB,gBAAX,CAA4B,EAA5B,EAAgC,YAAM;AAC3D;AACAwK,eAAWlH,QAAX,GAAsBsH,iBAAiBtH,QAAvC;AACD,GAHsB,CAAvB;;AAKA,MAAIuH,YAAY,GAAhB;;AAEAJ,SAAOK,cAAP,GAAwB,UAASC,SAAT,EAAoB;AAC1C,QAAIC,WAAW,SAAXA,QAAW,CAACC,IAAD,EAAU;AACvB,aAAOA,KAAKC,IAAL,CAAU,UAACC,CAAD,EAAIC,CAAJ;AAAA,eAAU,CAACD,EAAEhE,OAAF,CAAUkE,KAAV,GAAkBD,EAAEjE,OAAF,CAAUkE,KAA7B,KAAuCF,EAAEhE,OAAF,CAAUkE,KAAV,GAAkBD,EAAEjE,OAAF,CAAUkE,KAAnE,CAAV;AAAA,OAAV,CAAP;AACD,KAFD;AAGA,QAAIC,WAAWP,UAAUQ,OAAV,CAAkB/C,KAAlB,EAAf;;AAEA,QAAIgD,kBAAkB,SAAlBA,eAAkB,CAASH,KAAT,EAAgB;AAAA;AAAA;AAAA;;AAAA;AACpC,8BAAeN,UAAUQ,OAAzB,mIAAkC;AAAA,cAA1BE,GAA0B;;AAChC,cAAGA,IAAItE,OAAJ,CAAYkE,KAAZ,KAAsBA,KAAzB,EAAgC;AAC9B,mBAAOI,GAAP;AACD;AACF;AALmC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAMpC,aAAO,IAAP;AACD,KAPD;;AAN0C;AAAA;AAAA;;AAAA;AAe1C,4BAAeV,UAAUQ,OAAzB,mIAAkC;AAAA,YAA1BE,GAA0B;;AAChC,YAAIC,eAAeD,IAAIzE,QAAJ,IAAgByE,IAAIzE,QAAJ,CAAa2E,IAAb,CAAkB,UAAClC,CAAD,EAAO;AAAC,iBAAOA,EAAEmC,KAAT;AAAe,SAAzC,CAAnC;AACAH,YAAIzE,QAAJ,GAAe,EAAf;AACAyE,YAAIvH,MAAJ,GAAa,IAAb;;AAEA,YAAGwH,YAAH,EAAiB;AACfD,cAAIzE,QAAJ,CAAa6E,OAAb,CAAqBH,YAArB;AACD;AACF;AAvByC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAuBzC;;AAvByC;AAAA;AAAA;;AAAA;AAyB1C,4BAAeX,UAAUQ,OAAzB,mIAAkC;AAAA,YAA1BE,GAA0B;;AAChC,YAAIK,OAAOL,IAAItE,OAAJ,CAAYkE,KAAvB;AACA,YAAIU,QAAQD,KAAKE,KAAL,CAAWnB,SAAX,CAAZ;AACAY,YAAIQ,YAAJ,GAAmBF,MAAMA,MAAM9M,MAAN,GAAc,CAApB,CAAnB;AACA,YAAG8M,MAAM9M,MAAN,IAAgB,CAAnB,EAAsB;AACpBwM,cAAIvH,MAAJ,GAAa6G,SAAb;AACA;AACD;;AAED,YAAImB,YAAY,SAAZA,SAAY,GAAoB;AAAA,cAAXC,KAAW,uEAAH,CAAG;;AAClC,cAAIC,cAAcL,MAAMvD,KAAN,CAAY,CAAZ,EAAeuD,MAAM9M,MAAN,GAAekN,KAA9B,EAAqCE,IAArC,CAA0CxB,SAA1C,CAAlB;AACA,cAAGuB,YAAYnN,MAAZ,IAAsB,CAAzB,EAA4B;AAC1B,mBAAO,IAAP;AACD;AACD,cAAIiF,SAASsH,gBAAgBY,WAAhB,CAAb;;AAEA;AACA;AACA,cAAG,CAAClI,MAAD,IAAWiI,QAAQJ,MAAM9M,MAAN,GAAe,CAArC,EAAwC;AACtC,mBAAOiN,UAAUC,QAAQ,CAAlB,CAAP;AACD;;AAED;AACA,cAAIG,WAAWb,IAAItE,OAAJ,CAAYkE,KAAZ,CAAkB7C,KAAlB,CAAwB4D,YAAYnN,MAAZ,GAAmB,CAA3C,CAAf;AACAwM,cAAIQ,YAAJ,GAAmBK,QAAnB;;AAEA,iBAAOpI,MAAP;AACD,SAlBD;;AAoBA,YAAIA,SAASgI,WAAb;;AAEA;AACA,YAAG,CAAChI,MAAJ,EAAY;AACVuH,cAAIQ,YAAJ,GAAmBR,IAAItE,OAAJ,CAAYkE,KAA/B;AACAI,cAAIvH,MAAJ,GAAa6G,SAAb;AACA;AACD;;AAED7G,eAAO8C,QAAP,CAAgBnD,IAAhB,CAAqB4H,GAArB;AACAvH,eAAO8C,QAAP,GAAkBgE,SAAS9G,OAAO8C,QAAhB,CAAlB;AACAyE,YAAIvH,MAAJ,GAAaA,MAAb;;AAEA;AACA,YAAIqI,QAAQjB,SAASkB,OAAT,CAAiBf,GAAjB,CAAZ;AACAH,iBAASmB,MAAT,CAAgBF,KAAhB,EAAuB,CAAvB;;AAEA,YAAG9B,OAAOiC,WAAP,IAAsBjC,OAAOiC,WAAP,CAAmBnJ,IAAnB,IAA2BkI,IAAIlI,IAAxD,EAA8D;AAC5DkH,iBAAOiC,WAAP,GAAqBjB,GAArB;AACAhB,iBAAOkC,iBAAP,CAAyBlB,GAAzB,EAA8B,IAA9B;AACD;AACF;AA3EyC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AA6E1C,QAAIC,eAAeX,UAAU/D,QAAV,IAAsB+D,UAAU/D,QAAV,CAAmB2E,IAAnB,CAAwB,UAAClC,CAAD,EAAO;AAAC,aAAOA,EAAEmC,KAAT;AAAe,KAA/C,CAAzC;AACAb,cAAU/D,QAAV,GAAqBgE,SAASM,QAAT,CAArB;AACA,QAAGI,YAAH,EAAiB;AAAEX,gBAAU/D,QAAV,CAAmB6E,OAAnB,CAA2BH,YAA3B;AAA2C;AAC/D,GAhFD;;AAkFAjB,SAAOmC,YAAP,GAAsB,UAASC,QAAT,EAAmBC,QAAnB,EAA6B;AACjD,QAAIC,SAAStC,OAAOM,SAAP,CAAiBQ,OAAjB,CAAyBrJ,MAAzB,CAAgC,UAASuJ,GAAT,EAAa;AACxD,aAAOA,IAAIlI,IAAJ,KAAasJ,QAApB;AACD,KAFY,EAEV,CAFU,CAAb;;AAIA,QAAI/N,SAASgO,aAAa,GAAb,GAAmBrC,OAAOM,SAA1B,GAAsCN,OAAOM,SAAP,CAAiBQ,OAAjB,CAAyBrJ,MAAzB,CAAgC,UAASuJ,GAAT,EAAa;AAC9F,aAAOA,IAAIlI,IAAJ,KAAauJ,QAApB;AACD,KAFkD,EAEhD,CAFgD,CAAnD;;AAIA,QAAGhO,OAAOoF,MAAP,KAAkB6I,MAArB,EAA6B;AAC3B;AACD;;AAED,QAAIC,YAAY,CAACD,MAAD,CAAhB;;AAEA,QAAIE,iBAAiB,SAAjBA,cAAiB,CAASF,MAAT,EAAiB;AAAA;AAAA;AAAA;;AAAA;AACpC,8BAAiBA,OAAO/F,QAAxB,mIAAkC;AAAA,cAA1BkG,KAA0B;;AAChC,cAAIC,WAAWJ,OAAO5F,OAAP,CAAekE,KAAf,GAAuBR,SAAvB,GAAmCqC,MAAM/F,OAAN,CAAckE,KAAd,CAAoBW,KAApB,CAA0BnB,SAA1B,EAAqCrC,KAArC,CAA2C,CAAC,CAA5C,EAA+C,CAA/C,CAAlD;AACA0E,gBAAM/F,OAAN,CAAckE,KAAd,GAAsB8B,QAAtB;AACAH,oBAAUnJ,IAAV,CAAeqJ,KAAf;AACAD,yBAAeC,KAAf;AACD;AANmC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAOrC,KAPD;;AASA,QAAIC,QAAJ;AACA,QAAGrO,OAAOsO,MAAV,EAAkB;AAChBD,iBAAWJ,OAAO5F,OAAP,CAAekE,KAAf,CAAqBW,KAArB,CAA2BnB,SAA3B,EAAsCrC,KAAtC,CAA4C,CAAC,CAA7C,EAAgD,CAAhD,CAAX;AACD,KAFD,MAEO;AACL2E,iBAAWrO,OAAOqI,OAAP,CAAekE,KAAf,GAAuBR,SAAvB,GAAmCkC,OAAO5F,OAAP,CAAekE,KAAf,CAAqBW,KAArB,CAA2BnB,SAA3B,EAAsCrC,KAAtC,CAA4C,CAAC,CAA7C,EAAgD,CAAhD,CAA9C;AACD;AACDuE,WAAO5F,OAAP,CAAekE,KAAf,GAAuB8B,QAAvB;AACAF,mBAAeF,MAAf;AACAtC,WAAOK,cAAP,CAAsBL,OAAOM,SAA7B;;AAEAH,qBAAiB1E,SAAjB,CAA2B8G,SAA3B;AACD,GAnCD;;AAqCAvC,SAAO4C,SAAP,GAAmB,UAAS5B,GAAT,EAAc;AAC/B,QAAIJ,QAAQI,IAAItE,OAAJ,CAAYkE,KAAxB;AACA,QAAGA,MAAMiC,UAAN,CAAiB,IAAjB,CAAH,EAA2B;AACzB;AACA;;;;;;;;;;AAUA,UAAI;AACF,YAAIC,aAAapM,KAAKC,KAAL,CAAWiK,MAAMmC,SAAN,CAAgB,CAAhB,EAAmBnC,MAAMpM,MAAzB,CAAX,CAAjB;AACD,OAFD,CAEE,OAAOwO,CAAP,EAAU;AACVpL,cAAM,oIAAN;AACA;AACD;AACD,UAAIqL,WAAW;AACbhI,sBAAciF,mBADD;AAEbxD,iBAAS;AACPkE,iBAAOkC,WAAW,CAAX,CADA;AAEPI,qBAAW;AACTC,qBAASL,WAAW,CAAX,CADA;AAETM,sBAAUN,WAAW,CAAX,CAFD;AAGT9L,mBAAO8L,WAAW,CAAX;AAHE;AAFJ;AAFI,OAAf;AAWA3C,uBAAiB1F,UAAjB,CAA4BwI,QAA5B,EAAsC,UAACI,UAAD,EAAgB;AACpD;AACA;AACA;AACArD,eAAOsD,YAAP,GAAsBD,UAAtB;AACD,OALD;AAMD,KAnCD,MAmCO;AACLrC,UAAI/F,YAAJ,GAAmB,KAAnB;AACA,UAAI2F,KAAJ;AACA,UAAGI,IAAIvH,MAAJ,CAAWkJ,MAAd,EAAsB;AACpB/B,gBAAQI,IAAItE,OAAJ,CAAYkE,KAApB;AACD,OAFD,MAEO;AACLA,gBAAQI,IAAIvH,MAAJ,CAAWiD,OAAX,CAAmBkE,KAAnB,GAA2BR,SAA3B,GAAuCY,IAAItE,OAAJ,CAAYkE,KAA3D;AACD;AACDI,UAAItE,OAAJ,CAAYkE,KAAZ,GAAoBA,KAApB;AACAI,UAAIG,KAAJ,GAAY,KAAZ;AACAhB,uBAAiB1F,UAAjB,CAA4BuG,GAA5B,EAAiC,UAACqC,UAAD,EAAgB;AAC/CrD,eAAOsD,YAAP,GAAsBD,UAAtB;AACD,OAFD;AAGD;AACF,GAnDD;;AAqDArD,SAAOuD,SAAP,GAAmB,UAASvC,GAAT,EAAcwC,WAAd,EAA2B;AAC5C,QAAIC,aAAazC,IAAI/F,YAAJ,IAAoBiF,mBAArC;AACA;AACA,QAAGuD,UAAH,EAAe;AACbD,oBAAc,KAAd;AACD;;AAED,QAAIE,6BAA6B,SAA7BA,0BAA6B,GAAW;AAC1C,UAAG1D,OAAO2D,YAAV,EAAwB;AAAA;AAAA;AAAA;;AAAA;AACtB,gCAAuB3D,OAAO2D,YAA9B,mIAA4C;AAAA,gBAApC1B,WAAoC;;AAC1CjC,mBAAOkC,iBAAP,CAAyBD,WAAzB,EAAsC,KAAtC;AACD;AAHqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIvB;AACF,KAND;;AAQA,QAAGjB,IAAI2B,MAAJ,IAAc3B,IAAI4C,WAArB,EAAkC;AAChCF;AACA1D,aAAO2D,YAAP,GAAsB,EAAtB;AACAxD,uBAAiBnF,cAAjB;AACD,KAJD,MAIO;AACL,UAAG,CAACgF,OAAO2D,YAAX,EAAyB;AAAE3D,eAAO2D,YAAP,GAAsB,EAAtB;AAA2B;AACtD,UAAG,CAACF,UAAJ,EAAgB;AACdzD,eAAO2D,YAAP,CAAoBvK,IAApB,CAAyB4H,GAAzB;AACD;AACD,UAAGwC,eAAexD,OAAO2D,YAAP,CAAoBnP,MAApB,GAA6B,CAA/C,EAAkD;AAChD,YAAIyO,WAAWjD,OAAO6D,mCAAP,EAAf;AACA1D,yBAAiB5F,UAAjB,CAA4B0I,QAA5B;AACD,OAHD,MAGO;AACLS;AACA1D,eAAO2D,YAAP,GAAsBF,aAAa,EAAb,GAAkB,CAACzC,GAAD,CAAxC;AACAb,yBAAiB5F,UAAjB,CAA4ByG,GAA5B;AACD;AACF;;AAED;AACA;AACA;;AAEA,QAAG,CAACwC,WAAD,IAAgBxD,OAAOiC,WAAvB,IAAsCjC,OAAOiC,WAAP,IAAsBjB,GAA/D,EAAoE;AAClEhB,aAAOkC,iBAAP,CAAyBlC,OAAOiC,WAAhC,EAA6C,KAA7C;AACAjC,aAAOiC,WAAP,CAAmB6B,OAAnB,GAA6B,KAA7B;AACD,KAHD,MAGO,IAAG9D,OAAOiC,WAAP,CAAmBU,MAAnB,IAA6B3C,OAAOiC,WAAP,CAAmB2B,WAAhD,IAA+D5D,OAAOiC,WAAP,CAAmBhH,YAAnB,IAAmCiF,mBAArG,EAA0H;AAC/HF,aAAOkC,iBAAP,CAAyBlC,OAAOiC,WAAhC,EAA6C,KAA7C;AACD;;AAED,QAAGjC,OAAOiC,WAAP,KAAuBjB,GAAvB,IAA8B,CAACA,IAAI2B,MAAtC,EAA8C;AAC5C3B,UAAI8C,OAAJ,GAAc,IAAd;AACD;;AAED9D,WAAOiC,WAAP,GAAqBjB,GAArB;AACAhB,WAAOkC,iBAAP,CAAyBlB,GAAzB,EAA8B,IAA9B;AACD,GAnDD;;AAqDAhB,SAAO6D,mCAAP,GAA6C,YAAW;AACtD,QAAIZ,WAAW;AACbnK,YAAM0G,KAAKC,MAAL,EADO;AAEbxE,oBAAc,aAFD;AAGbyB,eAAS;AACPkE,eAAO;AADA;AAHI,KAAf;;AAQA,QAAImD,WAAW/D,OAAO2D,YAAP,CAAoB7I,GAApB,CAAwB,UAACkG,GAAD,EAAS;AAAC,aAAOA,IAAItE,OAAJ,CAAYkE,KAAnB;AAAyB,KAA3D,CAAf;AACA,QAAIsC,YAAY,CAAC,MAAD,EAAS,UAAT,EAAqB,CAAC,OAAD,EAAU,IAAV,EAAgBa,QAAhB,CAArB,CAAhB;AACAd,aAASvG,OAAT,CAAiBwG,SAAjB,GAA6BA,SAA7B;AACA,WAAOD,QAAP;AACD,GAbD;;AAeAjD,SAAOgE,cAAP,GAAwB,UAAShD,GAAT,EAAc;AACpCA,QAAIiD,UAAJ,CAAeC,SAAf,GAA2B,CAAClD,IAAIiD,UAAJ,CAAeC,SAA3C;AACA,QAAG,CAAClD,IAAI2B,MAAR,EAAgB;AACdxC,uBAAiB7E,QAAjB,CAA0B0F,GAA1B;AACD;AACF,GALD;;AAOAhB,SAAOmE,QAAP,GAAkB,UAAS3D,IAAT,EAAe;AAC/BL,qBAAiB1E,SAAjB,CAA2B+E,IAA3B;AACD,GAFD;;AAIAR,SAAOkC,iBAAP,GAA2B,UAASlB,GAAT,EAAcoD,QAAd,EAAwB;AACjDpD,QAAIoD,QAAJ,GAAeA,QAAf;AACD,GAFD;;AAIAjE,mBAAiBpG,WAAjB,CAA6B,CAAC,KAAD,EAAQmG,mBAAR,CAA7B,EAA2D,UAACmE,OAAD,EAAa;AACtEpE,aAAS,YAAM;AACb,UAAIqE,UAAUtE,OAAOM,SAAP,GAAmBN,OAAOM,SAAP,CAAiBQ,OAApC,GAA8C,EAA5D;AACA,UAAIyD,YAAYvE,OAAOwE,cAAP,GAAwBxE,OAAOwE,cAAP,CAAsB1D,OAA9C,GAAwD,EAAxE;AAFa;AAAA;AAAA;;AAAA;AAGb,8BAAeuD,OAAf,mIAAwB;AAAA,cAAhBrD,GAAgB;;AACtB,cAAIyC,aAAazC,IAAI/F,YAAJ,IAAoBiF,mBAArC;AACA,cAAIuE,aAAahB,aAAac,SAAb,GAAyBD,OAA1C;;AAEA,cAAII,WAAWD,WAAWhN,MAAX,CAAkB,UAACkN,YAAD,EAAkB;AACjD,mBAAOA,aAAa7L,IAAb,KAAsBkI,IAAIlI,IAAjC;AACD,WAFc,EAEZ,CAFY,CAAf;;AAIA,cAAG4L,QAAH,EAAa;AACX7P,mBAAOyH,MAAP,CAAcoI,QAAd,EAAwB1D,GAAxB;AACD,WAFD,MAEO,IAAGA,IAAItE,OAAJ,CAAYkE,KAAf,EAAsB;AAC3B6D,uBAAWrL,IAAX,CAAgB4H,GAAhB;AACD;;AAED,cAAGA,IAAI4D,OAAP,EAAgB;AACd,gBAAI9C,QAAQ2C,WAAW1C,OAAX,CAAmB2C,YAAY1D,GAA/B,CAAZ;AACAyD,uBAAWzC,MAAX,CAAkBF,KAAlB,EAAyB,CAAzB;AACD,WAHD,MAGO;AACL,gBAAG9B,OAAOsD,YAAP,IAAuBtD,OAAOsD,YAAP,CAAoBxK,IAApB,IAA4BkI,IAAIlI,IAA1D,EAAiE;AAC/DkH,qBAAOsD,YAAP,GAAsB,IAAtB;AACAtD,qBAAOuD,SAAP,CAAiBvC,GAAjB;AACD,aAHD,MAGO,IAAG0D,YAAY1E,OAAOiC,WAAP,CAAmBnJ,IAAnB,IAA2B4L,SAAS5L,IAAnD,EAAyD;AAC9D;AACAkH,qBAAOkC,iBAAP,CAAyBwC,QAAzB,EAAmC,IAAnC;AACD;AACF;AACF;AA7BY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AA+Bb,UAAG,CAAC1E,OAAOM,SAAX,EAAsB;AACpBN,eAAOM,SAAP,GAAmB;AACjBqC,kBAAQ,IADS;AAEjBjG,mBAAS;AACPkE,mBAAO;AADA,WAFQ;AAKjBY,wBAAc,KALG;AAMjB1I,gBAAM,GANW;AAOjBmL,sBAAY;AAPK,SAAnB;AASD;;AAED,UAAG,CAACjE,OAAOwE,cAAX,EAA2B;AACzBxE,eAAOwE,cAAP,GAAwB;AACtB7B,kBAAQ,IADc;AAEtBiB,uBAAa,IAFS;AAGtBlH,mBAAS;AACPkE,mBAAO;AADA,WAHa;AAMtBY,wBAAc,OANQ;AAOtB1I,gBAAM,GAPgB;AAQtBmL,sBAAY;AARU,SAAxB;AAUD;;AAEDjE,aAAOM,SAAP,CAAiBQ,OAAjB,GAA2BwD,OAA3B;AACAtE,aAAOwE,cAAP,CAAsB1D,OAAtB,GAAgCyD,SAAhC;;AAEA,UAAG,CAACvE,OAAOiC,WAAR,IAAwBjC,OAAOiC,WAAP,IAAsBjC,OAAOiC,WAAP,CAAmBU,MAApE,EAA6E;AAC3E,YAAG3C,OAAOiC,WAAP,IAAsBjC,OAAOiC,WAAP,CAAmB2B,WAA5C,EAAyD;AACvD5D,iBAAOiC,WAAP,GAAqBjC,OAAOwE,cAA5B;AACAxE,iBAAOkC,iBAAP,CAAyBlC,OAAOM,SAAhC,EAA2C,KAA3C;AACD,SAHD,MAGO;AACLN,iBAAOiC,WAAP,GAAqBjC,OAAOM,SAA5B;AACAN,iBAAOkC,iBAAP,CAAyBlC,OAAOwE,cAAhC,EAAgD,KAAhD;AACD;AACDxE,eAAOkC,iBAAP,CAAyBlC,OAAOiC,WAAhC,EAA6C,IAA7C;AACD;;AAED,UAAGjC,OAAOiC,WAAP,CAAmB2C,OAAtB,EAA+B;AAC7B5E,eAAOuD,SAAP,CAAiBvD,OAAOM,SAAxB;AACD;;AAEDN,aAAOK,cAAP,CAAsBL,OAAOM,SAA7B;AACAN,aAAOK,cAAP,CAAsBL,OAAOwE,cAA7B;AACD,KA5ED;AA6ED,GA9ED;;AAgFAxE,SAAO6E,SAAP,GAAmB,UAAS7D,GAAT,EAAc;AAC/B,QAAIyC,aAAazC,IAAI/F,YAAJ,IAAoBiF,mBAArC;AACA,QAAIuE,aAAahB,aAAazD,OAAOwE,cAAP,CAAsB1D,OAAnC,GAA6Cd,OAAOM,SAAP,CAAiBQ,OAA/E;;AAEA,QAAIE,MAAMyD,WAAWhN,MAAX,CAAkB,UAASkN,YAAT,EAAsB;AAChD,aAAOA,aAAa7L,IAAb,KAAsBkI,IAAIlI,IAAjC;AACD,KAFS,EAEP,CAFO,CAAV;;AAIA,QAAIgM,cAAc,EAAlB;;AAEA,aAASC,WAAT,CAAqB/D,GAArB,EAA0B;AACxB8D,kBAAY1L,IAAZ,CAAiB4H,GAAjB;AACA,UAAGA,IAAIzE,QAAP,EAAiB;AAAA;AAAA;AAAA;;AAAA;AACf,iCAAiByE,IAAIzE,QAArB,wIAA+B;AAAA,gBAAvBkG,KAAuB;;AAC7BsC,wBAAYtC,KAAZ;AACD;AAHc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIhB;AACF;;AAEDsC,gBAAY/D,GAAZ;;AAEAb,qBAAiBhF,WAAjB,CAA6B2J,WAA7B;AACD,GAtBD;AAuBD,C;;AAGH;;;AACAhF,SAASkF,WAAT,GAAuB,IAAvB;;AAEAnF,QAAQF,MAAR,CAAe,KAAf,EAAsBsF,UAAtB,CAAiC,UAAjC,EAA6CnF,QAA7C;AACA,CAACD,QACEF,MADF,CACS,KADT,EAEEuF,SAFF,CAEY,aAFZ,EAE2B,CAAC,UAAD,EAAa,UAASjF,QAAT,EAAmB;AACxD,SAAO;AACLkF,cAAU,GADL;AAELC,WAAO;AACLC,mBAAa;AADR,KAFF;AAKLjI,UAAO,cAAS4C,MAAT,EAAiBsF,QAAjB,EAA2B;AAChCrF,eAAS,YAAW;AAClB,YAAGD,OAAOqF,WAAV,EAAuB;AACrBC,mBAAS,CAAT,EAAYC,KAAZ;AACD;AACF,OAJD;AAKD;AAXI,GAAP;AAaD,CAdyB,CAF3B;AAiBD,CAAC1F,QACEF,MADF,CACS,KADT,EAEEuF,SAFF,CAEY,WAFZ,EAEyB,YAAW;AACnC,SAAQ;AACNE,WAAO;AACLI,aAAO,GADF;AAELC,YAAM,GAFD;AAGLC,mBAAa,GAHR;AAILC,mBAAa;AAJR,KADD;AAONvI,UAAM,cAASgI,KAAT,EAAgB/G,OAAhB,EAAyBuH,KAAzB,EAAgC;AACpC;AACA,UAAIC,KAAKxH,QAAQ,CAAR,CAAT;;AAEAwH,SAAGC,SAAH,GAAeV,MAAMM,WAArB;;AAEA,UAAIK,UAAU,CAAd;;AAEAF,SAAG/O,gBAAH,CACE,WADF,EAEE,UAASkM,CAAT,EAAY;AACV+C,kBAAU,CAAV;AACA/C,UAAEgD,YAAF,CAAeC,aAAf,GAA+B,MAA/B;AACAjD,UAAEgD,YAAF,CAAeE,OAAf,CAAuB,OAAvB,EAAgCxP,KAAK8C,SAAL,CAAe4L,MAAMI,KAArB,CAAhC;AACA,aAAKW,SAAL,CAAeC,GAAf,CAAmB,MAAnB;AACA,eAAO,KAAP;AACD,OARH,EASE,KATF;;AAYAP,SAAG/O,gBAAH,CACE,SADF,EAEE,UAASkM,CAAT,EAAY;AACV,aAAKmD,SAAL,CAAeE,MAAf,CAAsB,MAAtB;AACA,aAAKF,SAAL,CAAeE,MAAf,CAAsB,MAAtB;AACA,eAAO,KAAP;AACD,OANH,EAOE,KAPF;;AAUAR,SAAG/O,gBAAH,CACE,UADF,EAEE,UAASkM,CAAT,EAAY;AACVA,UAAEgD,YAAF,CAAeM,UAAf,GAA4B,MAA5B;AACA;AACA,YAAItD,EAAEuD,cAAN,EAAsBvD,EAAEuD,cAAF;AACtB,YAAGnB,MAAMO,WAAT,EAAsB;AAAE,eAAKQ,SAAL,CAAeC,GAAf,CAAmB,MAAnB;AAA6B;AACrD,eAAO,KAAP;AACD,OARH,EASE,KATF;;AAYAP,SAAG/O,gBAAH,CACE,WADF,EAEE,UAASkM,CAAT,EAAY;AACV+C;AACA,YAAGX,MAAMO,WAAT,EAAsB;AAAE,eAAKQ,SAAL,CAAeC,GAAf,CAAmB,MAAnB;AAA6B;AACrD,eAAO,KAAP;AACD,OANH,EAOE,KAPF;;AAUAP,SAAG/O,gBAAH,CACE,WADF,EAEE,UAASkM,CAAT,EAAY;AACV+C;AACC,YAAIA,YAAY,CAAhB,EAAmB;AACjB,eAAKI,SAAL,CAAeE,MAAf,CAAsB,MAAtB;AACD;AACF,eAAO,KAAP;AACD,OARH,EASE,KATF;;AAYAR,SAAG/O,gBAAH,CACE,UADF,EAEE,UAASkM,CAAT,EAAY;AACV;AACA;AACG,aAAKmD,SAAL,CAAeE,MAAf,CAAsB,MAAtB;AACH;AACA,eAAO,KAAP;AACD,OARH,EASE,KATF;;AAYAR,SAAG/O,gBAAH,CACE,MADF,EAEE,UAASkM,CAAT,EAAY;;AAEV;AACA+C,kBAAU,CAAV;AACA,YAAI/C,EAAEwD,eAAN,EAAuBxD,EAAEwD,eAAF;;AAEvB,aAAKL,SAAL,CAAeE,MAAf,CAAsB,MAAtB;;AAEA,YAAIhE,WAAW3L,KAAKC,KAAL,CAAWqM,EAAEgD,YAAF,CAAeS,OAAf,CAAuB,OAAvB,CAAX,CAAf;AACA,YAAGpE,aAAa+C,MAAMI,KAAtB,EAA6B;AAC3B;AACD;AACDJ,cAAMsB,MAAN,CAAa,UAAStB,KAAT,EAAgB;AAC3BA,gBAAMK,IAAN,GAAapD,QAAb,EAAuB+C,MAAMI,KAA7B;AACD,SAFD;;AAIA,eAAO,KAAP;AACD,OAnBH,EAoBE,KApBF;AAuBD;AA1GK,GAAR;AA4GD,CA/GA;AAgHD;IAAOmB,O;AAEL,qBAAc;AAAA;;AACZ,SAAKxB,QAAL,GAAgB,GAAhB;AACA,SAAKyB,WAAL,GAAmB,0BAAnB;AACA,SAAKxB,KAAL,GAAa;AACXpE,WAAK,GADM;AAEXmB,oBAAc,GAFH;AAGX0E,gBAAU,GAHC;AAIXjE,iBAAW,GAJA;AAKXuB,gBAAU,GALC;AAMXU,iBAAW,GANA;AAOXiC,wBAAkB;AAPP,KAAb;AASD;;;;+BAEU9G,M,EAAQC,Q,EAAU;AAC3B;;AAEAD,aAAO0F,WAAP,GAAqB,YAAW;AAC9B,eAAO,CAAC1F,OAAOgB,GAAP,CAAW2B,MAAZ,IAAsB3C,OAAOgB,GAAP,CAAW/F,YAAX,IAA2B,aAAxD;AACD,OAFD;;AAIA+E,aAAO2F,WAAP,GAAqB,YAAW;AAC9B,eAAO,CAAC3F,OAAOgB,GAAP,CAAW4C,WAAZ,IAA2B5D,OAAOgB,GAAP,CAAW/F,YAAX,IAA2B,aAA7D;AACD,OAFD;;AAIA+E,aAAO+G,MAAP,GAAgB,UAAS3E,QAAT,EAAmBC,QAAnB,EAA6B;AAC3CrC,eAAOmC,YAAP,GAAsBC,QAAtB,EAAgCC,QAAhC;AACD,OAFD;;AAIArC,aAAOgH,UAAP,GAAoB,UAAS5Q,KAAT,EAAgB,CAEnC,CAFD;;AAIA4J,aAAOiH,WAAP,GAAqB,UAAS7Q,KAAT,EAAgB,CAEpC,CAFD;;AAIA4J,aAAOuD,SAAP,GAAmB,UAASnN,KAAT,EAAgB;AACjC,YAAIoN,cAAcpN,MAAM8Q,OAAN,IAAiB9Q,MAAM+Q,OAAzC;AACAnH,eAAO6G,QAAP,GAAkB7G,OAAOgB,GAAzB,EAA8BwC,WAA9B;AACD,OAHD;;AAKAxD,aAAOoH,QAAP,GAAkB,UAASC,MAAT,EAAiB5N,MAAjB,EAAyB;AACzC4N,eAAOb,eAAP;AACA,YAAIc,YAAY,EAACnG,OAAO,IAAR,EAAc1H,QAAQA,MAAtB,EAA8BiD,SAAS,EAACkE,OAAO,EAAR,EAAvC,EAAhB;AACAnH,eAAO8C,QAAP,CAAgB6E,OAAhB,CAAwBkG,SAAxB;AACD,OAJD;;AAMAtH,aAAOuH,UAAP,GAAoB,UAASvG,GAAT,EAAc;AAChC,YAAGA,IAAItE,OAAJ,CAAYkE,KAAZ,IAAqBI,IAAItE,OAAJ,CAAYkE,KAAZ,CAAkBpM,MAAlB,GAA2B,CAAnD,EAAsD;AACpDwL,iBAAO4C,SAAP,GAAmB5B,GAAnB;AACD;AACDA,YAAIvH,MAAJ,CAAW8C,QAAX,CAAoByF,MAApB,CAA2BhB,IAAIvH,MAAJ,CAAW8C,QAAX,CAAoBwF,OAApB,CAA4Bf,GAA5B,CAA3B,EAA6D,CAA7D;AACD,OALD;;AAOAhB,aAAOwH,SAAP,GAAmB,UAASxG,GAAT,EAAc;AAC/BhB,eAAO6E,SAAP,GAAmB7D,GAAnB;AACD,OAFD;;AAIAhB,aAAOyH,aAAP,GAAuB,UAASzG,GAAT,EAAc;AACnC,YAAGhB,OAAO8G,gBAAP,EAAH,EAA8B;AAC5B9G,iBAAO8G,gBAAP,GAA0B9F,GAA1B;AACD;AACF,OAJD;;AAMAhB,aAAO0H,aAAP,GAAuB,UAAS1G,GAAT,EAAc;AACnC,YAAG,CAACA,IAAIQ,YAAL,IAAqBR,IAAIQ,YAAJ,CAAiBhN,MAAjB,IAA2B,CAAnD,EAAsD;AACpD;AACAwL,iBAAO6E,SAAP,GAAmB7D,GAAnB;AACA;AACD;AACD,YAAIZ,YAAY,GAAhB;AACA,YAAII,OAAO,CAACQ,GAAD,CAAX;AACA,YAAIJ,KAAJ;AACA,YAAGI,IAAIvH,MAAJ,CAAWkJ,MAAd,EAAsB;AACpB/B,kBAAQI,IAAIQ,YAAZ;AACD,SAFD,MAEO;AACLZ,kBAAQI,IAAIvH,MAAJ,CAAWiD,OAAX,CAAmBkE,KAAnB,GAA2BR,SAA3B,GAAuCY,IAAIQ,YAAnD;AACD;;AAEDR,YAAItE,OAAJ,CAAYkE,KAAZ,GAAoBA,KAApB;;AAEA,iBAAS+G,cAAT,CAAwB3G,GAAxB,EAA6B;AAAA;AAAA;AAAA;;AAAA;AAC3B,mCAAiBA,IAAIzE,QAArB,wIAA+B;AAAA,kBAAvBkG,KAAuB;;AAC7BA,oBAAM/F,OAAN,CAAckE,KAAd,GAAsB6B,MAAMhJ,MAAN,CAAaiD,OAAb,CAAqBkE,KAArB,GAA6BR,SAA7B,GAAyCqC,MAAMjB,YAArE;AACAhB,mBAAKpH,IAAL,CAAUqJ,KAAV;AACAkF,6BAAelF,KAAf;AACD;AAL0B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAM5B;;AAEDkF,uBAAe3G,GAAf;;AAEAA,YAAI8C,OAAJ,GAAc,KAAd;;AAEA9D,eAAOmE,QAAP,GAAkB3D,IAAlB;AACD,OA9BD;;AAgCAR,aAAO4H,gBAAP,GAA0B,UAAS5G,GAAT,EAAc;AACtC,YAAI6G,aAAa,CAAjB;AACA,YAAIpO,SAASuH,IAAIvH,MAAjB;AACA,eAAMA,MAAN,EAAc;AACZoO;AACApO,mBAASA,OAAOA,MAAhB;AACD;;AAED,eAAOoO,UAAP;AACD,OATD;;AAWA7H,aAAO8H,iBAAP,GAA2B,UAAS9G,GAAT,EAAc;AACvC,YAAGA,IAAI/F,YAAJ,IAAoB,aAAvB,EAAsC;AACpC,iBAAO,SAAP;AACD;;AAED;AACA,YAAG,CAAC+F,IAAIlI,IAAR,EAAc;AACZ,iBAAO,SAAP;AACD;;AAED;AACA,YAAGkI,IAAIiD,UAAJ,IAAkBjD,IAAIiD,UAAJ,CAAeC,SAApC,EAA+C;AAC7C,iBAAO,SAAP;AACD;;AAED,YAAI6D,MAAM/H,OAAO4H,gBAAP,CAAwB5G,GAAxB,CAAV;AACA,YAAIgH,cAAc;AAChB,aAAG,MADa;AAEhB,aAAG,MAFa;AAGhB,aAAG,SAHa;AAIhB,aAAG,QAJa;AAKhB,aAAG;AALa,UAMhBD,GANgB,CAAlB;;AAQA,eAAOC,cAAcA,WAAd,GAA4B,SAAnC;AACD,OAzBD;AA2BD;;;;;;AAGHrB,QAAQ3B,WAAR,GAAsB,IAAtB;;AAEAnF,QAAQF,MAAR,CAAe,KAAf,EAAsBuF,SAAtB,CAAgC,SAAhC,EAA2C;AAAA,SAAM,IAAIyB,OAAJ,EAAN;AAAA,CAA3C","file":"app.js","sourcesContent":["\"use strict\";\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar ComponentManager = function () {\n  function ComponentManager(permissions, onReady) {\n    var _this = this;\n\n    _classCallCheck(this, ComponentManager);\n\n    this.sentMessages = [];\n    this.messageQueue = [];\n    this.initialPermissions = permissions;\n    this.loggingEnabled = false;\n    this.acceptsThemes = true;\n    this.onReadyCallback = onReady;\n\n    this.coallesedSaving = true;\n    this.coallesedSavingDelay = 250;\n\n    var messageHandler = function messageHandler(event, mobileSource) {\n      if (_this.loggingEnabled) {\n        console.log(\"Components API Message received:\", event.data, \"mobile?\", mobileSource);\n      }\n\n      // The first message will be the most reliable one, so we won't change it after any subsequent events,\n      // in case you receive an event from another window.\n      if (!_this.origin) {\n        _this.origin = event.origin;\n      }\n      _this.mobileSource = mobileSource;\n      // If from mobile app, JSON needs to be used.\n      var data = mobileSource ? JSON.parse(event.data) : event.data;\n      _this.handleMessage(data);\n    };\n\n    // Mobile (React Native) uses `document`, web/desktop uses `window`.addEventListener\n    // for postMessage API to work properly.\n\n    document.addEventListener(\"message\", function (event) {\n      messageHandler(event, true);\n    }, false);\n\n    window.addEventListener(\"message\", function (event) {\n      messageHandler(event, false);\n    }, false);\n  }\n\n  _createClass(ComponentManager, [{\n    key: \"handleMessage\",\n    value: function handleMessage(payload) {\n      if (payload.action === \"component-registered\") {\n        this.sessionKey = payload.sessionKey;\n        this.componentData = payload.componentData;\n        this.onReady(payload.data);\n\n        if (this.loggingEnabled) {\n          console.log(\"Component successfully registered with payload:\", payload);\n        }\n      } else if (payload.action === \"themes\") {\n        if (this.acceptsThemes) {\n          this.activateThemes(payload.data.themes);\n        }\n      } else if (payload.original) {\n        // get callback from queue\n        var originalMessage = this.sentMessages.filter(function (message) {\n          return message.messageId === payload.original.messageId;\n        })[0];\n\n        if (!originalMessage) {\n          // Connection must have been reset. Alert the user.\n          alert(\"This extension is attempting to communicate with Standard Notes, but an error is preventing it from doing so. Please restart this extension and try again.\");\n        }\n\n        if (originalMessage.callback) {\n          originalMessage.callback(payload.data);\n        }\n      }\n    }\n  }, {\n    key: \"onReady\",\n    value: function onReady(data) {\n      if (this.initialPermissions && this.initialPermissions.length > 0) {\n        this.requestPermissions(this.initialPermissions);\n      }\n\n      var _iteratorNormalCompletion = true;\n      var _didIteratorError = false;\n      var _iteratorError = undefined;\n\n      try {\n        for (var _iterator = this.messageQueue[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n          var message = _step.value;\n\n          this.postMessage(message.action, message.data, message.callback);\n        }\n      } catch (err) {\n        _didIteratorError = true;\n        _iteratorError = err;\n      } finally {\n        try {\n          if (!_iteratorNormalCompletion && _iterator.return) {\n            _iterator.return();\n          }\n        } finally {\n          if (_didIteratorError) {\n            throw _iteratorError;\n          }\n        }\n      }\n\n      this.messageQueue = [];\n      this.environment = data.environment;\n      this.platform = data.platform;\n      this.uuid = data.uuid;\n\n      if (this.onReadyCallback) {\n        this.onReadyCallback();\n      }\n    }\n  }, {\n    key: \"getSelfComponentUUID\",\n    value: function getSelfComponentUUID() {\n      return this.uuid;\n    }\n  }, {\n    key: \"isRunningInDesktopApplication\",\n    value: function isRunningInDesktopApplication() {\n      return this.environment === \"desktop\";\n    }\n  }, {\n    key: \"setComponentDataValueForKey\",\n    value: function setComponentDataValueForKey(key, value) {\n      this.componentData[key] = value;\n      this.postMessage(\"set-component-data\", { componentData: this.componentData }, function (data) {});\n    }\n  }, {\n    key: \"clearComponentData\",\n    value: function clearComponentData() {\n      this.componentData = {};\n      this.postMessage(\"set-component-data\", { componentData: this.componentData }, function (data) {});\n    }\n  }, {\n    key: \"componentDataValueForKey\",\n    value: function componentDataValueForKey(key) {\n      return this.componentData[key];\n    }\n  }, {\n    key: \"postMessage\",\n    value: function postMessage(action, data, callback) {\n      if (!this.sessionKey) {\n        this.messageQueue.push({\n          action: action,\n          data: data,\n          callback: callback\n        });\n        return;\n      }\n\n      var message = {\n        action: action,\n        data: data,\n        messageId: this.generateUUID(),\n        sessionKey: this.sessionKey,\n        api: \"component\"\n      };\n\n      var sentMessage = JSON.parse(JSON.stringify(message));\n      sentMessage.callback = callback;\n      this.sentMessages.push(sentMessage);\n\n      // Mobile (React Native) requires a string for the postMessage API.\n      if (this.mobileSource) {\n        message = JSON.stringify(message);\n      }\n\n      if (this.loggingEnabled) {\n        console.log(\"Posting message:\", message);\n      }\n\n      window.parent.postMessage(message, this.origin);\n    }\n  }, {\n    key: \"setSize\",\n    value: function setSize(type, width, height) {\n      this.postMessage(\"set-size\", { type: type, width: width, height: height }, function (data) {});\n    }\n  }, {\n    key: \"requestPermissions\",\n    value: function requestPermissions(permissions, callback) {\n      this.postMessage(\"request-permissions\", { permissions: permissions }, function (data) {\n        callback && callback();\n      }.bind(this));\n    }\n  }, {\n    key: \"streamItems\",\n    value: function streamItems(contentTypes, callback) {\n      if (!Array.isArray(contentTypes)) {\n        contentTypes = [contentTypes];\n      }\n      this.postMessage(\"stream-items\", { content_types: contentTypes }, function (data) {\n        callback(data.items);\n      }.bind(this));\n    }\n  }, {\n    key: \"streamContextItem\",\n    value: function streamContextItem(callback) {\n      this.postMessage(\"stream-context-item\", null, function (data) {\n        var item = data.item;\n        /*\n          When an item is saved via saveItem, its updated_at value is set client side to the current date.\n          If we make a change locally, then for whatever reason receive an item via streamItems/streamContextItem,\n          we want to ignore that change if it was made prior to the latest change we've made.\n           Update 1/22/18: However, if a user is restoring a note from version history, this change\n          will not pass through this filter and will thus be ignored. Because the client now handles\n          this case with isMetadataUpdate, we no longer need the below.\n        */\n        // if(this.streamedContextItem && this.streamedContextItem.uuid == item.uuid\n        //   && this.streamedContextItem.updated_at > item.updated_at) {\n        //   return;\n        // }\n        // this.streamedContextItem = item;\n        callback(item);\n      });\n    }\n  }, {\n    key: \"selectItem\",\n    value: function selectItem(item) {\n      this.postMessage(\"select-item\", { item: this.jsonObjectForItem(item) });\n    }\n  }, {\n    key: \"createItem\",\n    value: function createItem(item, callback) {\n      this.postMessage(\"create-item\", { item: this.jsonObjectForItem(item) }, function (data) {\n        var item = data.item;\n\n        // A previous version of the SN app had an issue where the item in the reply to create-item\n        // would be nested inside \"items\" and not \"item\". So handle both cases here.\n        if (!item && data.items && data.items.length > 0) {\n          item = data.items[0];\n        }\n\n        this.associateItem(item);\n        callback && callback(item);\n      }.bind(this));\n    }\n  }, {\n    key: \"createItems\",\n    value: function createItems(items, callback) {\n      var _this2 = this;\n\n      var mapped = items.map(function (item) {\n        return _this2.jsonObjectForItem(item);\n      });\n      this.postMessage(\"create-items\", { items: mapped }, function (data) {\n        callback && callback(data.items);\n      }.bind(this));\n    }\n  }, {\n    key: \"associateItem\",\n    value: function associateItem(item) {\n      this.postMessage(\"associate-item\", { item: this.jsonObjectForItem(item) });\n    }\n  }, {\n    key: \"deassociateItem\",\n    value: function deassociateItem(item) {\n      this.postMessage(\"deassociate-item\", { item: this.jsonObjectForItem(item) });\n    }\n  }, {\n    key: \"clearSelection\",\n    value: function clearSelection() {\n      this.postMessage(\"clear-selection\", { content_type: \"Tag\" });\n    }\n  }, {\n    key: \"deleteItem\",\n    value: function deleteItem(item, callback) {\n      this.deleteItems([item], callback);\n    }\n  }, {\n    key: \"deleteItems\",\n    value: function deleteItems(items, callback) {\n      var params = {\n        items: items.map(function (item) {\n          return this.jsonObjectForItem(item);\n        }.bind(this))\n      };\n\n      this.postMessage(\"delete-items\", params, function (data) {\n        callback && callback(data);\n      });\n    }\n  }, {\n    key: \"sendCustomEvent\",\n    value: function sendCustomEvent(action, data, callback) {\n      this.postMessage(action, data, function (data) {\n        callback && callback(data);\n      }.bind(this));\n    }\n  }, {\n    key: \"saveItem\",\n    value: function saveItem(item, callback) {\n      var skipDebouncer = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n\n      this.saveItems([item], callback, skipDebouncer);\n    }\n\n    /* Presave allows clients to perform any actions last second before the save actually occurs (like setting previews).\n       Saves debounce by default, so if a client needs to compute a property on an item before saving, it's best to\n       hook into the debounce cycle so that clients don't have to implement their own debouncing.\n     */\n\n  }, {\n    key: \"saveItemWithPresave\",\n    value: function saveItemWithPresave(item, presave, callback) {\n      this.saveItemsWithPresave([item], presave, callback);\n    }\n  }, {\n    key: \"saveItemsWithPresave\",\n    value: function saveItemsWithPresave(items, presave, callback) {\n      this.saveItems(items, callback, false, presave);\n    }\n\n    /*\n    skipDebouncer allows saves to go through right away rather than waiting for timeout.\n    This should be used when saving items via other means besides keystrokes.\n     */\n\n  }, {\n    key: \"saveItems\",\n    value: function saveItems(items, callback) {\n      var _this3 = this;\n\n      var skipDebouncer = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n      var presave = arguments[3];\n\n      var saveBlock = function saveBlock() {\n        // presave block allows client to gain the benefit of performing something in the debounce cycle.\n        presave && presave();\n\n        var mappedItems = items.map(function (item) {\n          item.updated_at = new Date();\n          return this.jsonObjectForItem(item);\n        }.bind(_this3));\n\n        _this3.postMessage(\"save-items\", { items: mappedItems }, function (data) {\n          callback && callback();\n        });\n      };\n\n      /*\n        Coallesed saving prevents saves from being made after every keystroke, and instead\n        waits coallesedSavingDelay before performing action. For example, if a user types a keystroke, and the clienet calls saveItem,\n        a 250ms delay will begin. If they type another keystroke within 250ms, the previously pending\n        save will be cancelled, and another 250ms delay occurs. If ater 250ms the pending delay is not cleared by a future call,\n        the save will finally trigger.\n         Note: it's important to modify saving items updated_at immediately and not after delay. If you modify after delay,\n        a delayed sync could just be wrapping up, and will send back old data and replace what the user has typed.\n      */\n      if (this.coallesedSaving == true && !skipDebouncer) {\n        if (this.pendingSave) {\n          clearTimeout(this.pendingSave);\n        }\n\n        this.pendingSave = setTimeout(function () {\n          saveBlock();\n        }, this.coallesedSavingDelay);\n      } else {\n        saveBlock();\n      }\n    }\n  }, {\n    key: \"jsonObjectForItem\",\n    value: function jsonObjectForItem(item) {\n      var copy = Object.assign({}, item);\n      copy.children = null;\n      copy.parent = null;\n      return copy;\n    }\n  }, {\n    key: \"getItemAppDataValue\",\n    value: function getItemAppDataValue(item, key) {\n      var AppDomain = \"org.standardnotes.sn\";\n      var data = item.content.appData && item.content.appData[AppDomain];\n      if (data) {\n        return data[key];\n      } else {\n        return null;\n      }\n    }\n\n    /* Themes */\n\n  }, {\n    key: \"activateThemes\",\n    value: function activateThemes(urls) {\n      this.deactivateAllCustomThemes();\n\n      if (this.loggingEnabled) {\n        console.log(\"Activating themes:\", urls);\n      }\n\n      if (!urls) {\n        return;\n      }\n\n      var _iteratorNormalCompletion2 = true;\n      var _didIteratorError2 = false;\n      var _iteratorError2 = undefined;\n\n      try {\n        for (var _iterator2 = urls[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {\n          var url = _step2.value;\n\n          if (!url) {\n            continue;\n          }\n\n          var link = document.createElement(\"link\");\n          link.href = url;\n          link.type = \"text/css\";\n          link.rel = \"stylesheet\";\n          link.media = \"screen,print\";\n          link.className = \"custom-theme\";\n          document.getElementsByTagName(\"head\")[0].appendChild(link);\n        }\n      } catch (err) {\n        _didIteratorError2 = true;\n        _iteratorError2 = err;\n      } finally {\n        try {\n          if (!_iteratorNormalCompletion2 && _iterator2.return) {\n            _iterator2.return();\n          }\n        } finally {\n          if (_didIteratorError2) {\n            throw _iteratorError2;\n          }\n        }\n      }\n    }\n  }, {\n    key: \"deactivateAllCustomThemes\",\n    value: function deactivateAllCustomThemes() {\n      // make copy, as it will be modified during loop\n      // `getElementsByClassName` is an HTMLCollection, not an Array\n      var elements = Array.from(document.getElementsByClassName(\"custom-theme\")).slice();\n      var _iteratorNormalCompletion3 = true;\n      var _didIteratorError3 = false;\n      var _iteratorError3 = undefined;\n\n      try {\n        for (var _iterator3 = elements[Symbol.iterator](), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {\n          var element = _step3.value;\n\n          if (element) {\n            element.disabled = true;\n            element.parentNode.removeChild(element);\n          }\n        }\n      } catch (err) {\n        _didIteratorError3 = true;\n        _iteratorError3 = err;\n      } finally {\n        try {\n          if (!_iteratorNormalCompletion3 && _iterator3.return) {\n            _iterator3.return();\n          }\n        } finally {\n          if (_didIteratorError3) {\n            throw _iteratorError3;\n          }\n        }\n      }\n    }\n\n    /* Utilities */\n\n  }, {\n    key: \"generateUUID\",\n    value: function generateUUID() {\n      var crypto = window.crypto || window.msCrypto;\n      if (crypto) {\n        var buf = new Uint32Array(4);\n        crypto.getRandomValues(buf);\n        var idx = -1;\n        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n          idx++;\n          var r = buf[idx >> 3] >> idx % 8 * 4 & 15;\n          var v = c == 'x' ? r : r & 0x3 | 0x8;\n          return v.toString(16);\n        });\n      } else {\n        var d = new Date().getTime();\n        if (window.performance && typeof window.performance.now === \"function\") {\n          d += performance.now(); //use high-precision timer if available\n        }\n        var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n          var r = (d + Math.random() * 16) % 16 | 0;\n          d = Math.floor(d / 16);\n          return (c == 'x' ? r : r & 0x3 | 0x8).toString(16);\n        });\n        return uuid;\n      }\n    }\n  }]);\n\n  return ComponentManager;\n}();\n\nif (typeof module != \"undefined\" && typeof module.exports != \"undefined\") {\n  module.exports = ComponentManager;\n}\n\nif (window) {\n  window.ComponentManager = ComponentManager;\n}\n//# sourceMappingURL=dist.js.map\n;'use strict';\r\n\r\nangular.module('app', [\r\n\r\n])\r\n;class HomeCtrl {\r\n  constructor($rootScope, $scope, $timeout) {\r\n\r\n    let smartTagContentType = \"SN|SmartTag\";\r\n\r\n    let componentManager = new window.ComponentManager([], () => {\r\n      // on ready\r\n      $rootScope.platform = componentManager.platform;\r\n    });\r\n\r\n    let delimiter = \".\";\r\n\r\n    $scope.resolveRawTags = function(masterTag) {\r\n      let sortTags = (tags) => {\r\n        return tags.sort((a, b) => (a.content.title > b.content.title) - (a.content.title < b.content.title));\r\n      }\r\n      var resolved = masterTag.rawTags.slice();\r\n\r\n      var findResolvedTag = function(title) {\r\n        for(var tag of masterTag.rawTags) {\r\n          if(tag.content.title === title) {\r\n            return tag;\r\n          }\r\n        }\r\n        return null;\r\n      }\r\n\r\n      for(var tag of masterTag.rawTags) {\r\n        var pendingDummy = tag.children && tag.children.find((c) => {return c.dummy});\r\n        tag.children = [];\r\n        tag.parent = null;\r\n\r\n        if(pendingDummy) {\r\n          tag.children.unshift(pendingDummy);\r\n        }\r\n      };\r\n\r\n      for(var tag of masterTag.rawTags) {\r\n        var name = tag.content.title;\r\n        var comps = name.split(delimiter);\r\n        tag.displayTitle = comps[comps.length -1];\r\n        if(comps.length == 1) {\r\n          tag.parent = masterTag;\r\n          continue;\r\n        }\r\n\r\n        var getParent = function(depth = 1) {\r\n          var parentTitle = comps.slice(0, comps.length - depth).join(delimiter);\r\n          if(parentTitle.length == 0) {\r\n            return null;\r\n          }\r\n          var parent = findResolvedTag(parentTitle);\r\n\r\n          // didn't find parent, try again.\r\n          // just make sure we're not deeper in search than we can go\r\n          if(!parent && depth < comps.length - 1) {\r\n            return getParent(depth + 1);\r\n          }\r\n\r\n          // remove parent from name and keep this full tag name to display\r\n          var tagTitle = tag.content.title.slice(parentTitle.length+1);\r\n          tag.displayTitle = tagTitle;\r\n\r\n          return parent;\r\n        };\r\n\r\n        var parent = getParent();\r\n\r\n        // no parent at all up the tree, fall back to root with full name\r\n        if(!parent) {\r\n          tag.displayTitle = tag.content.title;\r\n          tag.parent = masterTag;\r\n          continue;\r\n        }\r\n\r\n        parent.children.push(tag);\r\n        parent.children = sortTags(parent.children);\r\n        tag.parent = parent;\r\n\r\n        // remove chid from master list\r\n        var index = resolved.indexOf(tag);\r\n        resolved.splice(index, 1);\r\n\r\n        if($scope.selectedTag && $scope.selectedTag.uuid == tag.uuid) {\r\n          $scope.selectedTag = tag;\r\n          $scope.setSelectedForTag(tag, true);\r\n        }\r\n      }\r\n\r\n      var pendingDummy = masterTag.children && masterTag.children.find((c) => {return c.dummy});\r\n      masterTag.children = sortTags(resolved);\r\n      if(pendingDummy) { masterTag.children.unshift(pendingDummy); }\r\n    }\r\n\r\n    $scope.changeParent = function(sourceId, targetId) {\r\n      var source = $scope.masterTag.rawTags.filter(function(tag){\r\n        return tag.uuid === sourceId;\r\n      })[0];\r\n\r\n      var target = targetId === \"0\" ? $scope.masterTag : $scope.masterTag.rawTags.filter(function(tag){\r\n        return tag.uuid === targetId;\r\n      })[0];\r\n\r\n      if(target.parent === source) {\r\n        return;\r\n      }\r\n\r\n      var needsSave = [source];\r\n\r\n      var adjustChildren = function(source) {\r\n        for(var child of source.children) {\r\n          var newTitle = source.content.title + delimiter + child.content.title.split(delimiter).slice(-1)[0];\r\n          child.content.title = newTitle;\r\n          needsSave.push(child);\r\n          adjustChildren(child);\r\n        }\r\n      }\r\n\r\n      var newTitle;\r\n      if(target.master) {\r\n        newTitle = source.content.title.split(delimiter).slice(-1)[0];\r\n      } else {\r\n        newTitle = target.content.title + delimiter + source.content.title.split(delimiter).slice(-1)[0];\r\n      }\r\n      source.content.title = newTitle;\r\n      adjustChildren(source);\r\n      $scope.resolveRawTags($scope.masterTag);\r\n\r\n      componentManager.saveItems(needsSave);\r\n    }\r\n\r\n    $scope.createTag = function(tag) {\r\n      var title = tag.content.title;\r\n      if(title.startsWith(\"![\")) {\r\n        // Create smart tag\r\n        /*\r\n        ![\"Untagged\", \"tags.length\", \"=\", 0]\r\n        ![\"B-tags\", \"tags\", \"includes\", [\"title\", \"startsWith\", \"b\"]]\r\n        ![\"Foo Notes\", \"title\", \"startsWith\", \"Foo\"]\r\n        ![\"Archived\", \"archived\", \"=\", true]\r\n        ![\"Pinned\", \"pinned\", \"=\", true]\r\n        ![\"Not Pinned\", \"pinned\", \"=\", false]\r\n        ![\"Last Day\", \"updated_at\", \">\", \"1.days.ago\"]\r\n        ![\"Long\", \"text.length\", \">\", 500]\r\n        */\r\n        try {\r\n          var components = JSON.parse(title.substring(1, title.length));\r\n        } catch (e) {\r\n          alert(\"There was an error parsing your smart tag syntax. Please ensure the value after the exclamation mark is valid JSON, and try again.\")\r\n          return;\r\n        }\r\n        var smartTag = {\r\n          content_type: smartTagContentType,\r\n          content: {\r\n            title: components[0],\r\n            predicate: {\r\n              keypath: components[1],\r\n              operator: components[2],\r\n              value: components[3]\r\n            }\r\n          }\r\n        }\r\n        componentManager.createItem(smartTag, (createdTag) => {\r\n          // We don't want to select the tag right away because it hasn't been added yet.\r\n          // If you do $scope.selectTag(createdTag), an issue occurs where selecting another tag\r\n          // after that will not dehighlight this one.\r\n          $scope.selectOnLoad = createdTag;\r\n        });\r\n      } else {\r\n        tag.content_type = \"Tag\";\r\n        var title;\r\n        if(tag.parent.master) {\r\n          title = tag.content.title;\r\n        } else {\r\n          title = tag.parent.content.title + delimiter + tag.content.title;\r\n        }\r\n        tag.content.title = title;\r\n        tag.dummy = false;\r\n        componentManager.createItem(tag, (createdTag) => {\r\n          $scope.selectOnLoad = createdTag;\r\n        });\r\n      }\r\n    }\r\n\r\n    $scope.selectTag = function(tag, multiSelect) {\r\n      let isSmartTag = tag.content_type == smartTagContentType;\r\n      // Multi selection for smart tags is not possible.\r\n      if(isSmartTag) {\r\n        multiSelect = false;\r\n      }\r\n\r\n      let clearMultipleTagsSelection = function() {\r\n        if($scope.multipleTags) {\r\n          for(var selectedTag of $scope.multipleTags) {\r\n            $scope.setSelectedForTag(selectedTag, false);\r\n          }\r\n        }\r\n      }\r\n\r\n      if(tag.master || tag.smartMaster) {\r\n        clearMultipleTagsSelection();\r\n        $scope.multipleTags = [];\r\n        componentManager.clearSelection();\r\n      } else {\r\n        if(!$scope.multipleTags) { $scope.multipleTags = []; }\r\n        if(!isSmartTag) {\r\n          $scope.multipleTags.push(tag);\r\n        }\r\n        if(multiSelect && $scope.multipleTags.length > 1) {\r\n          var smartTag = $scope.createEphemeralSmartTagForMultiTags();\r\n          componentManager.selectItem(smartTag);\r\n        } else {\r\n          clearMultipleTagsSelection();\r\n          $scope.multipleTags = isSmartTag ? [] : [tag];\r\n          componentManager.selectItem(tag);\r\n        }\r\n      }\r\n\r\n      // if multiselect, we don't want to clear selected tag. But if master is selected,\r\n      // and multi select other tag, we do want to clear master. Rather than creating a large if\r\n      // statement, we'll just an if else.\r\n\r\n      if(!multiSelect && $scope.selectedTag && $scope.selectedTag != tag) {\r\n        $scope.setSelectedForTag($scope.selectedTag, false);\r\n        $scope.selectedTag.editing = false;\r\n      } else if($scope.selectedTag.master || $scope.selectedTag.smartMaster || $scope.selectedTag.content_type == smartTagContentType) {\r\n        $scope.setSelectedForTag($scope.selectedTag, false);\r\n      }\r\n\r\n      if($scope.selectedTag === tag && !tag.master) {\r\n        tag.editing = true;\r\n      }\r\n\r\n      $scope.selectedTag = tag;\r\n      $scope.setSelectedForTag(tag, true);\r\n    }\r\n\r\n    $scope.createEphemeralSmartTagForMultiTags = function() {\r\n      let smartTag = {\r\n        uuid: Math.random(),\r\n        content_type: \"SN|SmartTag\",\r\n        content: {\r\n          title: \"Multiple tags\"\r\n        }\r\n      }\r\n\r\n      var tagNames = $scope.multipleTags.map((tag) => {return tag.content.title});\r\n      var predicate = [\"tags\", \"includes\", [\"title\", \"in\", tagNames]];\r\n      smartTag.content.predicate = predicate;\r\n      return smartTag;\r\n    }\r\n\r\n    $scope.toggleCollapse = function(tag) {\r\n      tag.clientData.collapsed = !tag.clientData.collapsed;\r\n      if(!tag.master) {\r\n        componentManager.saveItem(tag);\r\n      }\r\n    }\r\n\r\n    $scope.saveTags = function(tags) {\r\n      componentManager.saveItems(tags);\r\n    }\r\n\r\n    $scope.setSelectedForTag = function(tag, selected) {\r\n      tag.selected = selected;\r\n    }\r\n\r\n    componentManager.streamItems([\"Tag\", smartTagContentType], (newTags) => {\r\n      $timeout(() => {\r\n        var allTags = $scope.masterTag ? $scope.masterTag.rawTags : [];\r\n        var smartTags = $scope.smartMasterTag ? $scope.smartMasterTag.rawTags : [];\r\n        for(var tag of newTags) {\r\n          var isSmartTag = tag.content_type == smartTagContentType;\r\n          var arrayToUse = isSmartTag ? smartTags : allTags;\r\n\r\n          var existing = arrayToUse.filter((tagCandidate) => {\r\n            return tagCandidate.uuid === tag.uuid;\r\n          })[0];\r\n\r\n          if(existing) {\r\n            Object.assign(existing, tag);\r\n          } else if(tag.content.title) {\r\n            arrayToUse.push(tag);\r\n          }\r\n\r\n          if(tag.deleted) {\r\n            var index = arrayToUse.indexOf(existing || tag);\r\n            arrayToUse.splice(index, 1);\r\n          } else {\r\n            if($scope.selectOnLoad && $scope.selectOnLoad.uuid == tag.uuid)  {\r\n              $scope.selectOnLoad = null;\r\n              $scope.selectTag(tag);\r\n            } else if(existing && $scope.selectedTag.uuid == existing.uuid) {\r\n              // Don't call $scope.selectTag(existing) as this will double select a tag, which will enable editing for it.\r\n              $scope.setSelectedForTag(existing, true);\r\n            }\r\n          }\r\n        }\r\n\r\n        if(!$scope.masterTag) {\r\n          $scope.masterTag = {\r\n            master: true,\r\n            content: {\r\n              title: \"\"\r\n            },\r\n            displayTitle: \"All\",\r\n            uuid: \"0\",\r\n            clientData: {}\r\n          }\r\n        }\r\n\r\n        if(!$scope.smartMasterTag) {\r\n          $scope.smartMasterTag = {\r\n            master: true,\r\n            smartMaster: true,\r\n            content: {\r\n              title: \"\"\r\n            },\r\n            displayTitle: \"Views\",\r\n            uuid: \"1\",\r\n            clientData: {}\r\n          }\r\n        }\r\n\r\n        $scope.masterTag.rawTags = allTags;\r\n        $scope.smartMasterTag.rawTags = smartTags;\r\n\r\n        if(!$scope.selectedTag || ($scope.selectedTag && $scope.selectedTag.master)) {\r\n          if($scope.selectedTag && $scope.selectedTag.smartMaster) {\r\n            $scope.selectedTag = $scope.smartMasterTag;\r\n            $scope.setSelectedForTag($scope.masterTag, false);\r\n          } else {\r\n            $scope.selectedTag = $scope.masterTag;\r\n            $scope.setSelectedForTag($scope.smartMasterTag, false);\r\n          }\r\n          $scope.setSelectedForTag($scope.selectedTag, true);\r\n        }\r\n\r\n        if($scope.selectedTag.deleted) {\r\n          $scope.selectTag($scope.masterTag);\r\n        }\r\n\r\n        $scope.resolveRawTags($scope.masterTag);\r\n        $scope.resolveRawTags($scope.smartMasterTag);\r\n      })\r\n    });\r\n\r\n    $scope.deleteTag = function(tag) {\r\n      var isSmartTag = tag.content_type == smartTagContentType;\r\n      var arrayToUse = isSmartTag ? $scope.smartMasterTag.rawTags : $scope.masterTag.rawTags;\r\n\r\n      var tag = arrayToUse.filter(function(tagCandidate){\r\n        return tagCandidate.uuid === tag.uuid;\r\n      })[0];\r\n\r\n      var deleteChain = [];\r\n\r\n      function addChildren(tag) {\r\n        deleteChain.push(tag);\r\n        if(tag.children) {\r\n          for(var child of tag.children) {\r\n            addChildren(child);\r\n          }\r\n        }\r\n      }\r\n\r\n      addChildren(tag);\r\n\r\n      componentManager.deleteItems(deleteChain);\r\n    }\r\n  }\r\n}\r\n\r\n// required for firefox\r\nHomeCtrl.$$ngIsClass = true;\r\n\r\nangular.module('app').controller('HomeCtrl', HomeCtrl);\r\n;angular\r\n  .module('app')\r\n  .directive('mbAutofocus', ['$timeout', function($timeout) {\r\n    return {\r\n      restrict: 'A',\r\n      scope: {\r\n        shouldFocus: \"=\"\r\n      },\r\n      link : function($scope, $element) {\r\n        $timeout(function() {\r\n          if($scope.shouldFocus) {\r\n            $element[0].focus();\r\n          }\r\n        });\r\n      }\r\n    }\r\n  }]);\r\n;angular\r\n  .module('app')\r\n  .directive('draggable', function() {\r\n  return  {\r\n    scope: {\r\n      tagId: \"=\",\r\n      drop: '&',\r\n      isDraggable: \"=\",\r\n      isDroppable: \"=\"\r\n    },\r\n    link: function(scope, element, attrs) {\r\n      // 'ngInject';\r\n      var el = element[0];\r\n\r\n      el.draggable = scope.isDraggable;\r\n\r\n      var counter = 0;\r\n\r\n      el.addEventListener(\r\n        'dragstart',\r\n        function(e) {\r\n          counter = 0;\r\n          e.dataTransfer.effectAllowed = 'move';\r\n          e.dataTransfer.setData('TagId', JSON.stringify(scope.tagId));\r\n          this.classList.add('drag');\r\n          return false;\r\n        },\r\n        false\r\n      );\r\n\r\n      el.addEventListener(\r\n        'dragend',\r\n        function(e) {\r\n          this.classList.remove('drag');\r\n          this.classList.remove('over');\r\n          return false;\r\n        },\r\n        false\r\n      );\r\n\r\n      el.addEventListener(\r\n        'dragover',\r\n        function(e) {\r\n          e.dataTransfer.dropEffect = 'move';\r\n          // allows us to drop\r\n          if (e.preventDefault) e.preventDefault();\r\n          if(scope.isDroppable) { this.classList.add('over'); }\r\n          return false;\r\n        },\r\n        false\r\n      );\r\n\r\n      el.addEventListener(\r\n        'dragenter',\r\n        function(e) {\r\n          counter++;\r\n          if(scope.isDroppable) { this.classList.add('over'); }\r\n          return false;\r\n        },\r\n        false\r\n      );\r\n\r\n      el.addEventListener(\r\n        'dragleave',\r\n        function(e) {\r\n          counter--;\r\n           if (counter === 0) {\r\n             this.classList.remove('over');\r\n           }\r\n          return false;\r\n        },\r\n        false\r\n      );\r\n\r\n      el.addEventListener(\r\n        'dragexit',\r\n        function(e) {\r\n          // counter--;\r\n          //  if (counter === 0) {\r\n             this.classList.remove('over');\r\n          //  }\r\n          return false;\r\n        },\r\n        false\r\n      );\r\n\r\n      el.addEventListener(\r\n        'drop',\r\n        function(e) {\r\n\r\n          // Stops some browsers from redirecting.\r\n          counter = 0;\r\n          if (e.stopPropagation) e.stopPropagation();\r\n\r\n          this.classList.remove('over');\r\n\r\n          var targetId = JSON.parse(e.dataTransfer.getData('TagId'));\r\n          if(targetId === scope.tagId) {\r\n            return;\r\n          }\r\n          scope.$apply(function(scope) {\r\n            scope.drop()(targetId, scope.tagId);\r\n          });\r\n\r\n          return false;\r\n        },\r\n        false\r\n      );\r\n\r\n    }\r\n  }\r\n});\r\n;class TagTree {\r\n\r\n  constructor() {\r\n    this.restrict = \"C\";\r\n    this.templateUrl = \"directives/tag_tree.html\";\r\n    this.scope = {\r\n      tag: \"=\",\r\n      changeParent: \"&\",\r\n      onSelect: \"&\",\r\n      createTag: \"&\",\r\n      saveTags: \"&\",\r\n      deleteTag: \"&\",\r\n      onToggleCollapse: \"&\"\r\n    };\r\n  }\r\n\r\n  controller($scope, $timeout) {\r\n    'ngInject';\r\n\r\n    $scope.isDraggable = function() {\r\n      return !$scope.tag.master && $scope.tag.content_type != 'SN|SmartTag';\r\n    }\r\n\r\n    $scope.isDroppable = function() {\r\n      return !$scope.tag.smartMaster && $scope.tag.content_type != 'SN|SmartTag';\r\n    }\r\n\r\n    $scope.onDrop = function(sourceId, targetId) {\r\n      $scope.changeParent()(sourceId, targetId);\r\n    }\r\n\r\n    $scope.onDragOver = function(event) {\r\n\r\n    }\r\n\r\n    $scope.onDragStart = function(event) {\r\n\r\n    }\r\n\r\n    $scope.selectTag = function(event) {\r\n      let multiSelect = event.ctrlKey || event.metaKey;\r\n      $scope.onSelect()($scope.tag, multiSelect);\r\n    }\r\n\r\n    $scope.addChild = function($event, parent) {\r\n      $event.stopPropagation();\r\n      var addingTag = {dummy: true, parent: parent, content: {title: \"\"}};\r\n      parent.children.unshift(addingTag);\r\n    }\r\n\r\n    $scope.saveNewTag = function(tag) {\r\n      if(tag.content.title && tag.content.title.length > 0) {\r\n        $scope.createTag()(tag);\r\n      }\r\n      tag.parent.children.splice(tag.parent.children.indexOf(tag), 1);\r\n    }\r\n\r\n    $scope.removeTag = function(tag) {\r\n      $scope.deleteTag()(tag);\r\n    }\r\n\r\n    $scope.innerCollapse = function(tag) {\r\n      if($scope.onToggleCollapse()) {\r\n        $scope.onToggleCollapse()(tag);\r\n      }\r\n    }\r\n\r\n    $scope.saveTagRename = function(tag) {\r\n      if(!tag.displayTitle || tag.displayTitle.length == 0) {\r\n        // Delete\r\n        $scope.deleteTag()(tag);\r\n        return;\r\n      }\r\n      var delimiter = \".\";\r\n      var tags = [tag];\r\n      var title;\r\n      if(tag.parent.master) {\r\n        title = tag.displayTitle;\r\n      } else {\r\n        title = tag.parent.content.title + delimiter + tag.displayTitle;\r\n      }\r\n\r\n      tag.content.title = title;\r\n\r\n      function renameChildren(tag) {\r\n        for(var child of tag.children) {\r\n          child.content.title = child.parent.content.title + delimiter + child.displayTitle;\r\n          tags.push(child);\r\n          renameChildren(child);\r\n        }\r\n      }\r\n\r\n      renameChildren(tag);\r\n\r\n      tag.editing = false;\r\n\r\n      $scope.saveTags()(tags);\r\n    }\r\n\r\n    $scope.generationForTag = function(tag) {\r\n      var generation = 0;\r\n      var parent = tag.parent;\r\n      while(parent) {\r\n        generation++;\r\n        parent = parent.parent;\r\n      }\r\n\r\n      return generation;\r\n    }\r\n\r\n    $scope.circleClassForTag = function(tag) {\r\n      if(tag.content_type == \"SN|SmartTag\") {\r\n        return \"success\";\r\n      }\r\n\r\n      // is newly creating tag\r\n      if(!tag.uuid) {\r\n        return \"default\";\r\n      }\r\n\r\n      // Newly creating tags don't have client data\r\n      if(tag.clientData && tag.clientData.collapsed) {\r\n        return \"warning\";\r\n      }\r\n\r\n      let gen = $scope.generationForTag(tag);\r\n      var circleClass = {\r\n        0: \"info\",\r\n        1: \"info\",\r\n        2: \"success\",\r\n        3: \"danger\",\r\n        4: \"warning\"\r\n      }[gen];\r\n\r\n      return circleClass ? circleClass : \"default\";\r\n    }\r\n\r\n  }\r\n}\r\n\r\nTagTree.$$ngIsClass = true;\r\n\r\nangular.module('app').directive('tagTree', () => new TagTree);\r\n"]}